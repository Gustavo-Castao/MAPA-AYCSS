<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo Arte y Ciencias Sociales</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 13px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 6.5px;
            padding: 13px;
            box-shadow: 0 1.3px 6.5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 13px;
            position: relative;
        }

        h1 {
            text-align: center;
            color: #333;
            font-size: 1.2em; /* 50% m√°s peque√±o */
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 5px 10px;
            border: 1px dashed transparent;
            transition: border-color 0.3s;
        }

        h1:hover {
            border-color: #ccc;
        }

        .edit-title-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            color: #666;
            transition: color 0.3s;
        }

        .edit-title-btn:hover {
            color: #333;
        }

        .main-content {
            display: flex;
            gap: 13px;
        }

        .left-controls {
            display: flex;
            flex-direction: column;
            gap: 5.2px;
            width: 150px;
        }

        button {
            padding: 6.5px 10.4px;
            border: none;
            border-radius: 3.9px;
            cursor: pointer;
            font-size: 8.45px;
            font-weight: bold;
            transition: all 0.2s ease;
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            width: 100%;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-export { background: #6f42c1; color: white; }
        .btn-preview { background: #20c997; color: white; }
        .btn-png { background: #e74c3c; color: white; }
        .btn-bg { 
            background: #6c757d; 
            color: white; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 1.3px 5.2px rgba(0,0,0,0.15);
        }

        .workspace-container {
            position: relative;
            width: 100%;
            height: 1000px;
            overflow: auto;
            border: 1.3px solid #e0e0e0;
            border-radius: 5.2px;
            margin-bottom: 13px;
            background: white;
            transition: background-color 0.3s ease;
            flex: 1;
        }

        .workspace {
            position: relative;
            width: 3500px; /* Nuevo ancho */
            height: 2400px; /* Nuevo alto */
            transform-origin: 0 0;
            transition: transform 0.3s ease;
            background: white;
        }

        .node {
            position: absolute;
            min-width: 73px;
            max-width: 100px;
            padding: 5.5px;
            background: white;
            border-radius: 5.2px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 1.3px 5.2px rgba(0,0,0,0.15);
            border: 1.3px solid #e0e0e0;
            user-select: none;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 0.65em;
        }

        .node:hover {
            transform: scale(1.03);
            box-shadow: 0 2.6px 7.8px rgba(0,0,0,0.2);
        }

        .node.dragging {
            transform: scale(1.05);
            box-shadow: 0 3.9px 13px rgba(0,0,0,0.25);
            z-index: 1000;
            cursor: grabbing;
        }

        .node-main {
            border-color: #2196F3;
            background: #f8fdff;
        }

        .node-topic {
            border-color: #FF9800;
            background: #fffbf5;
        }

        .node-subtopic {
            border-color: #9C27B0;
            background: #fcf5ff;
        }

        .node-title {
            font-family: 'EB Garamond', 'Garamond', 'Times New Roman', serif;
            font-weight: 600;
            font-size: 9.1px;
            margin-bottom: 1.3px;
            line-height: 1.2;
        }

        .node-subtitle {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 500;
            font-size: 8.45px;
            margin-bottom: 5.2px;
            font-style: italic;
            line-height: 1.2;
            opacity: 0.8;
        }

        .node-author {
            display: none;
        }

        .text-black { color: #000000 !important; }
        .text-gray { color: #666666 !important; }
        .text-white { color: #ffffff !important; }

        .bg-white { background: #ffffff !important; }
        .bg-light { background: #f8f9fa !important; }
        .bg-dark { 
            background: #2c3e50 !important; 
            border-color: #34495e !important;
        }

        .border-none { border-color: transparent !important; }
        .border-red { border-color: #dc3545 !important; }
        .border-blue { border-color: #007bff !important; }
        .border-green { border-color: #28a745 !important; }
        .border-purple { border-color: #6f42c1 !important; }
        .border-orange { border-color: #fd7e14 !important; }

        .connection {
            position: absolute;
            background: #95a5a6;
            height: 1.95px;
            transform-origin: 0 0;
            pointer-events: none;
            z-index: 5;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 5.2px solid transparent;
            border-right: 5.2px solid transparent;
            border-top: 7.8px solid #95a5a6;
            transform-origin: center;
            pointer-events: none;
            z-index: 6;
        }

        .connection-mode {
            background: #fff3cd;
            color: #856404;
            padding: 5.2px;
            border-radius: 2.6px;
            text-align: center;
            margin-bottom: 5.2px;
            display: none;
            font-weight: bold;
            font-size: 8.45px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 3.25% auto;
            padding: 19.5px;
            border-radius: 6.5px;
            width: 90%;
            max-width: 455px;
            box-shadow: 0 3.25px 16.25px rgba(0,0,0,0.3);
            position: relative;
            max-height: 55.25vh;
            overflow-y: auto;
            animation: zoomIn 0.3s ease;
            transform-origin: center center;
        }

        .node-form {
            background: #f8f9fa;
            padding: 10.4px;
            border-radius: 5.2px;
            margin-bottom: 10.4px;
            display: none;
            font-size: 0.65em;
        }

        .form-group {
            margin-bottom: 7.8px;
        }

        label {
            display: block;
            margin-bottom: 2.6px;
            font-weight: bold;
            color: #333;
            font-size: 8.45px;
        }

        input, select, textarea {
            width: 100%;
            padding: 5.2px;
            border: 0.65px solid #ddd;
            border-radius: 2.6px;
            font-size: 8.45px;
            background: white;
        }

        .color-options {
            display: flex;
            gap: 6.5px;
            margin-top: 6.5px;
        }

        .color-option {
            width: 19.5px;
            height: 19.5px;
            border-radius: 50%;
            cursor: pointer;
            border: 1.3px solid transparent;
            transition: all 0.2s ease;
        }

        .color-option.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .bg-color-options .color-option.bg-white { background: #ffffff; border: 0.65px solid #ddd; }
        .bg-color-options .color-option.bg-light { background: #f8f9fa; border: 0.65px solid #ddd; }
        .bg-color-options .color-option.bg-dark { background: #2c3e50; }

        .text-color-options .color-option.text-black { background: #000000; }
        .text-color-options .color-option.text-gray { background: #666666; }
        .text-color-options .color-option.text-white { background: #ffffff; border: 0.65px solid #ddd; }

        .border-color-options .color-option.border-none { 
            background: #ffffff; 
            border: 1.3px solid #ddd;
            position: relative;
        }
        .border-color-options .color-option.border-none::after {
            content: "X";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #dc3545;
            font-weight: bold;
        }
        .border-color-options .color-option.border-red { background: #dc3545; }
        .border-color-options .color-option.border-blue { background: #007bff; }
        .border-color-options .color-option.border-green { background: #28a745; }
        .border-color-options .color-option.border-purple { background: #6f42c1; }
        .border-color-options .color-option.border-orange { background: #fd7e14; }

        .info-panel {
            background: #f8f9fa;
            padding: 10.4px;
            border-radius: 5.2px;
            margin-bottom: 10.4px;
            font-size: 0.65em;
        }

        .info-panel h3 {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 600;
        }

        .node-actions {
            margin-top: 5.2px;
            display: flex;
            gap: 2.6px;
            justify-content: center;
        }

        .node-btn {
            padding: 2.6px 5.2px;
            font-size: 7.15px;
            border-radius: 7.8px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .node-btn:hover {
            transform: scale(1.05);
        }

        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }

        .export-panel {
            background: #e8f5e8;
            padding: 10.4px;
            border-radius: 5.2px;
            margin-top: 10.4px;
            display: none;
            font-size: 0.65em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .close-modal {
            position: absolute;
            right: 10.4px;
            top: 10.4px;
            font-size: 15.6px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            padding: 0;
            width: 19.5px;
            height: 19.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-title {
            font-family: 'EB Garamond', serif;
            font-size: 18.2px;
            margin-bottom: 6.5px;
            color: #333;
        }

        .modal-subtitle {
            font-family: 'EB Garamond', serif;
            font-size: 9.1px;
            margin-bottom: 10.4px;
            color: #666;
            font-style: italic;
        }

        .modal-author {
            font-family: 'Calibri', sans-serif;
            font-size: 7.8px;
            margin-bottom: 13px;
            color: #888;
            font-style: italic;
        }

        .modal-image {
            max-width: 100%;
            max-height: 195px;
            margin: 10.4px 0;
            border-radius: 5.2px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-description {
            font-family: 'Calibri', sans-serif;
            font-size: 10.4px;
            line-height: 1.6;
            color: #333;
            padding: 13px;
            background: #f8f9fa;
            border-radius: 3.25px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 97.5px;
            margin-top: 6.5px;
            border-radius: 2.6px;
            display: none;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 5px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 20;
        }

        .zoom-controls button {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 2px;
        }

        .node-highlight {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .map-bg-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }

        .bg-color-option {
            width: 25px;
            height: 25px;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: all 0.2s ease;
        }

        .bg-color-option.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .bg-label {
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 5px;
            text-align: center;
        }

        .node-delete-mode {
            background: #dc3545;
            color: white;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 768px) {
            .workspace-container {
                height: 500px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .left-controls {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            button {
                width: auto;
                flex: 1;
            }
            
            .node {
                min-width: 64px;
                padding: 4.5px;
            }
            
            .node-title {
                font-size: 8.2px;
            }
            
            .modal-content {
                margin: 1.3% auto;
                width: 95%;
                padding: 13px;
            }
            
            h1 {
                font-size: 1em;
            }
        }

        .pdf-export-area {
            background: white;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title-container">
            <h1 id="mapTitle" contenteditable="true">MAPA INTERACTIVO ARTE Y CIENCIAS SOCIALES</h1>
            <button class="edit-title-btn" title="Editar t√≠tulo">‚úèÔ∏è</button>
        </div>
        
        <div class="connection-mode" id="connectionMode">
            üîó Modo Conexi√≥n: Selecciona el nodo destino
        </div>

        <div class="main-content">
            <div class="left-controls">
                <button class="btn-primary" onclick="showNodeFormModal('main')">‚ûï Tema Principal</button>
                <button class="btn-info" onclick="startConnection()">üîó Conectar Nodos</button>
                <button class="btn-danger" id="deleteNodeBtn" onclick="toggleDeleteMode()">üóëÔ∏è Eliminar Nodo</button>
                <button class="btn-bg" onclick="document.getElementById('fileInput').click()">üìÇ Abrir HTML</button>
                <button class="btn-preview" onclick="openPreviewInNewWindow()">üëÅÔ∏è Vista Previa</button>
                <button class="btn-export" onclick="showExportPanel()">üíæ Exportar HTML</button>
                <button class="btn-png" onclick="exportToPNG()">üñºÔ∏è Exportar PNG</button>
                <button class="btn-warning" onclick="changeMapBackground('#ffffff', this)">üé® Color de Fondo</button>
                
                <input type="file" id="fileInput" class="file-input" accept=".html" onchange="loadHTMLFile(this.files[0])">
            </div>

            <div class="workspace-container" id="workspaceContainer">
                <div class="workspace" id="workspace">
                    <!-- Los nodos y conexiones se crear√°n aqu√≠ -->
                </div>
                <div class="zoom-controls">
                    <button class="btn-info" onclick="zoomIn()">+</button>
                    <button class="btn-info" onclick="zoomOut()">-</button>
                    <button class="btn-info" onclick="resetZoom()">‚ü≥</button>
                </div>
            </div>
        </div>

        <!-- Modal para formulario de nodo -->
        <div id="nodeFormModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="hideNodeFormModal()">&times;</button>
                <h3 style="font-family: 'EB Garamond', serif; font-size: 10.4px;" id="formTitle">Crear Nuevo Nodo</h3>
                <div class="form-group">
                    <label for="nodeTitle">T√≠tulo:</label>
                    <input type="text" id="nodeTitle" placeholder="Ej: Inteligencia Artificial">
                </div>
                <div class="form-group">
                    <label for="nodeSubtitle">Subt√≠tulo:</label>
                    <input type="text" id="nodeSubtitle" placeholder="Ej: Definici√≥n y conceptos b√°sicos">
                </div>
                <div class="form-group">
                    <label for="nodeAuthor">Texto o Autor:</label>
                    <input type="text" id="nodeAuthor" placeholder="Ej: Roger Charnier (1990)">
                </div>
                <div class="form-group">
                    <label for="nodeDescription">Descripci√≥n:</label>
                    <textarea id="nodeDescription" placeholder="Ej: La inteligencia artificial es el campo de la inform√°tica que se centra en la creaci√≥n de sistemas que pueden realizar tareas que normalmente requieren inteligencia humana..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="nodeImage">Imagen (opcional):</label>
                    <input type="file" id="nodeImage" accept="image/*" onchange="previewImage(this)">
                    <img id="imagePreview" class="image-preview" alt="Vista previa de imagen">
                </div>
                <div class="form-group">
                    <label for="nodeType">Tipo:</label>
                    <select id="nodeType">
                        <option value="main">Tema Principal</option>
                        <option value="topic">Subtema</option>
                        <option value="subtopic">Detalle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Color de fondo:</label>
                    <div class="color-options bg-color-options">
                        <div class="color-option bg-white active" onclick="selectBgColor('white', this)"></div>
                        <div class="color-option bg-light" onclick="selectBgColor('light', this)"></div>
                        <div class="color-option bg-dark" onclick="selectBgColor('dark', this)"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Color de texto:</label>
                    <div class="color-options text-color-options">
                        <div class="color-option text-black active" onclick="selectTextColor('black', this)"></div>
                        <div class="color-option text-gray" onclick="selectTextColor('gray', this)"></div>
                        <div class="color-option text-white" onclick="selectTextColor('white', this)"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Color del borde:</label>
                    <div class="color-options border-color-options">
                        <div class="color-option border-none" onclick="selectBorderColor('none', this)"></div>
                        <div class="color-option border-blue active" onclick="selectBorderColor('blue', this)"></div>
                        <div class="color-option border-red" onclick="selectBorderColor('red', this)"></div>
                        <div class="color-option border-green" onclick="selectBorderColor('green', this)"></div>
                        <div class="color-option border-purple" onclick="selectBorderColor('purple', this)"></div>
                        <div class="color-option border-orange" onclick="selectBorderColor('orange', this)"></div>
                    </div>
                </div>

                <button class="btn-success" onclick="saveNode()">‚úÖ Guardar Nodo</button>
                <button class="btn-danger" onclick="hideNodeFormModal()">‚ùå Cancelar</button>
            </div>
        </div>

        <!-- Modal para descripci√≥n -->
        <div id="descriptionModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal()">&times;</button>
                <h2 class="modal-title" id="modalTitle"></h2>
                <h3 class="modal-subtitle" id="modalSubtitle"></h3>
                <div class="modal-author" id="modalAuthor"></div>
                <img id="modalImage" class="modal-image" style="display: none;" alt="Imagen del nodo">
                <div class="modal-description" id="modalDescription"></div>
            </div>
        </div>

        <div class="export-panel" id="exportPanel">
            <h3>üíæ Exportar Mapa</h3>
            <p>Guarda este c√≥digo HTML para alojarlo en cualquier servidor:</p>
            <textarea id="exportCode" rows="6" style="width: 100%; font-family: monospace; font-size: 7.8px; padding: 6.5px; border: 0.65px solid #ddd; border-radius: 2.6px;"></textarea>
            <div style="margin-top: 6.5px;">
                <button class="btn-success" onclick="copyToClipboard()">üìã Copiar C√≥digo</button>
                <button class="btn-primary" onclick="downloadHTML()">‚¨áÔ∏è Descargar HTML</button>
                <button class="btn-danger" onclick="hideExportPanel()">‚ùå Cerrar</button>
            </div>
        </div>

        <div class="info-panel">
            <h3>üí° Informaci√≥n del Mapa</h3>
            <div id="nodeInfo">
                <p>Haz doble click en cualquier nodo para ver sus opciones</p>
                <p>Total de nodos: <span id="nodesCount">0</span> | Conexiones: <span id="connectionsCount">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let nodes = [];
        let connections = [];
        let connectionMode = false;
        let deleteMode = false;
        let sourceNodeId = null;
        let nodeCounter = 0;
        let selectedBgColor = 'white';
        let selectedTextColor = 'black';
        let selectedBorderColor = 'blue';
        let currentImage = null;
        let editingNodeId = null;
        let isViewMode = false;
        let zoomLevel = 1;
        let isPanning = false;
        let startPanX, startPanY, initialTranslateX = 0, initialTranslateY = 0;
        let translateX = 0, translateY = 0;

        // Elementos DOM
        const workspace = document.getElementById('workspace');
        const workspaceContainer = document.getElementById('workspaceContainer');
        const nodeFormModal = document.getElementById('nodeFormModal');
        const formTitle = document.getElementById('formTitle');
        const connectionModeDiv = document.getElementById('connectionMode');
        const nodeInfo = document.getElementById('nodeInfo');
        const exportPanel = document.getElementById('exportPanel');
        const descriptionModal = document.getElementById('descriptionModal');
        const mapTitle = document.getElementById('mapTitle');
        const deleteNodeBtn = document.getElementById('deleteNodeBtn');

        // Vista previa de imagen
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    currentImage = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                currentImage = null;
            }
        }

        // Seleccionar color de fondo
        function selectBgColor(color, element) {
            selectedBgColor = color;
            document.querySelectorAll('.bg-color-options .color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Seleccionar color de texto
        function selectTextColor(color, element) {
            selectedTextColor = color;
            document.querySelectorAll('.text-color-options .color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Seleccionar color del borde
        function selectBorderColor(color, element) {
            selectedBorderColor = color;
            document.querySelectorAll('.border-color-options .color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Cambiar color de fondo del mapa
        function changeMapBackground(color, element) {
            workspaceContainer.style.backgroundColor = color;
            // Actualizar todos los botones de color de fondo
            document.querySelectorAll('.btn-bg').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
        }

        // Mostrar formulario de nodo en modal
        function showNodeFormModal(type) {
            editingNodeId = null;
            formTitle.textContent = 'Crear Nuevo Nodo';
            document.getElementById('nodeType').value = type;
            clearForm();
            nodeFormModal.style.display = 'block';
            isViewMode = false;
        }

        // Ocultar formulario de nodo en modal
        function hideNodeFormModal() {
            nodeFormModal.style.display = 'none';
            editingNodeId = null;
        }

        // Mostrar formulario de nodo para edici√≥n
        function showEditForm(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            editingNodeId = nodeId;
            formTitle.textContent = 'Editar Nodo';
            
            // Llenar formulario con datos existentes
            document.getElementById('nodeTitle').value = node.title;
            document.getElementById('nodeSubtitle').value = node.subtitle || '';
            document.getElementById('nodeAuthor').value = node.author || '';
            document.getElementById('nodeDescription').value = node.description || '';
            document.getElementById('nodeType').value = node.type;
            
            // Seleccionar colores
            selectedBgColor = node.bgColor;
            selectedTextColor = node.textColor;
            selectedBorderColor = node.borderColor || 'blue';
            
            // Actualizar selectores de color
            updateColorSelectors();
            
            // Manejar imagen
            const preview = document.getElementById('imagePreview');
            if (node.image) {
                preview.src = node.image;
                preview.style.display = 'block';
                currentImage = node.image;
            } else {
                preview.style.display = 'none';
                currentImage = null;
            }
            
            nodeFormModal.style.display = 'block';
            isViewMode = false;
        }

        // Actualizar selectores de color
        function updateColorSelectors() {
            document.querySelectorAll('.bg-color-options .color-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.classList.contains('bg-' + selectedBgColor)) {
                    opt.classList.add('active');
                }
            });
            
            document.querySelectorAll('.text-color-options .color-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.classList.contains('text-' + selectedTextColor)) {
                    opt.classList.add('active');
                }
            });
            
            document.querySelectorAll('.border-color-options .color-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.classList.contains('border-' + selectedBorderColor)) {
                    opt.classList.add('active');
                }
            });
        }

        // Limpiar formulario
        function clearForm() {
            document.getElementById('nodeTitle').value = '';
            document.getElementById('nodeSubtitle').value = '';
            document.getElementById('nodeAuthor').value = '';
            document.getElementById('nodeDescription').value = '';
            document.getElementById('nodeImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            currentImage = null;
            
            // Resetear colores a valores por defecto
            selectedBgColor = 'white';
            selectedTextColor = 'black';
            selectedBorderColor = 'blue';
            updateColorSelectors();
        }

        // Guardar nodo (crear o editar)
        function saveNode() {
            const title = document.getElementById('nodeTitle').value.trim();
            const subtitle = document.getElementById('nodeSubtitle').value.trim();
            const author = document.getElementById('nodeAuthor').value.trim();
            const description = document.getElementById('nodeDescription').value.trim();
            const type = document.getElementById('nodeType').value;

            if (!title) {
                alert('Por favor ingresa un t√≠tulo');
                return;
            }

            if (editingNodeId) {
                // Editar nodo existente
                const node = nodes.find(n => n.id === editingNodeId);
                if (node) {
                    node.title = title;
                    node.subtitle = subtitle;
                    node.author = author;
                    node.description = description;
                    node.type = type;
                    node.bgColor = selectedBgColor;
                    node.textColor = selectedTextColor;
                    node.borderColor = selectedBorderColor;
                    node.image = currentImage;
                    
                    // Re-renderizar el nodo
                    renderAll();
                }
            } else {
                // Crear nuevo nodo
                nodeCounter++;
                const nodeId = 'node-' + nodeCounter;

                // Posici√≥n aleatoria en el workspace
                const x = Math.random() * (workspace.offsetWidth - 80) + 20;
                const y = Math.random() * (workspace.offsetHeight - 45) + 15;

                const node = {
                    id: nodeId,
                    title: title,
                    subtitle: subtitle,
                    author: author,
                    description: description,
                    image: currentImage,
                    type: type,
                    x: x,
                    y: y,
                    bgColor: selectedBgColor,
                    textColor: selectedTextColor,
                    borderColor: selectedBorderColor
                };

                nodes.push(node);
                renderNode(node);
                updateCounters();
            }

            hideNodeFormModal();
        }

        // Mostrar panel de exportaci√≥n
        function showExportPanel() {
            generateExportCode();
            exportPanel.style.display = 'block';
        }

        // Ocultar panel de exportaci√≥n
        function hideExportPanel() {
            exportPanel.style.display = 'none';
        }

        // Abrir vista previa en nueva ventana
        function openPreviewInNewWindow() {
            generateExportCode();
            const exportCode = document.getElementById('exportCode').value;
            const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
            
            newWindow.document.write(exportCode);
            newWindow.document.close();
        }

        // Mostrar modal de descripci√≥n
        function showDescriptionModal(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            document.getElementById('modalTitle').textContent = node.title;
            document.getElementById('modalSubtitle').textContent = node.subtitle || 'Sin subt√≠tulo';
            document.getElementById('modalAuthor').textContent = node.author ? `Autor: ${node.author}` : 'Autor no especificado';
            document.getElementById('modalDescription').textContent = node.description || 'Sin descripci√≥n disponible.';
            
            const modalImage = document.getElementById('modalImage');
            if (node.image) {
                modalImage.src = node.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            descriptionModal.style.display = 'block';
        }

        // Cerrar modal
        function closeModal() {
            descriptionModal.style.display = 'none';
        }

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', function(event) {
            if (event.target === descriptionModal || event.target === nodeFormModal) {
                descriptionModal.style.display = 'none';
                nodeFormModal.style.display = 'none';
            }
        });

        // Exportar a PNG
        function exportToPNG() {
            // Guardar el estado actual del zoom y transformaci√≥n
            const originalZoom = zoomLevel;
            const originalTranslateX = translateX;
            const originalTranslateY = translateY;
            
            // Restablecer el zoom y posici√≥n temporalmente
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateWorkspaceTransform();
            
            // Esperar un momento para que se aplique la transformaci√≥n
            setTimeout(() => {
                html2canvas(document.getElementById('workspace'), {
                    backgroundColor: workspaceContainer.style.backgroundColor || '#ffffff',
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    // Crear enlace de descarga
                    const link = document.createElement('a');
                    link.download = 'mapa-interactivo.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Restaurar el zoom y posici√≥n original despu√©s de exportar
                    zoomLevel = originalZoom;
                    translateX = originalTranslateX;
                    translateY = originalTranslateY;
                    updateWorkspaceTransform();
                });
            }, 500);
        }

        // Alternar modo de eliminaci√≥n
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            
            if (deleteMode) {
                deleteNodeBtn.classList.add('node-delete-mode');
                deleteNodeBtn.textContent = '‚ùå Cancelar Eliminar';
                nodeInfo.innerHTML = '<p>üóëÔ∏è Modo Eliminaci√≥n: Haz clic en un nodo para eliminarlo</p>';
            } else {
                deleteNodeBtn.classList.remove('node-delete-mode');
                deleteNodeBtn.textContent = 'üóëÔ∏è Eliminar Nodo';
                nodeInfo.innerHTML = '<p>Haz doble click en cualquier nodo para ver sus opciones</p><p>Total de nodos: <span id="nodesCount">' + nodes.length + '</span> | Conexiones: <span id="connectionsCount">' + connections.length + '</span></p>';
            }
        }

        // Cargar archivo HTML
        function loadHTMLFile(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Extraer datos del HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    
                    // Buscar script con los datos
                    const scripts = tempDiv.getElementsByTagName('script');
                    let mapData = null;
                    
                    for (let script of scripts) {
                        if (script.textContent.includes('const nodes =') && script.textContent.includes('const connections =')) {
                            // Evaluar el script para obtener los datos
                            try {
                                // Extraer solo las partes que necesitamos
                                const nodesMatch = script.textContent.match(/const nodes = (\[.*?\]);/s);
                                const connectionsMatch = script.textContent.match(/const connections = (\[.*?\]);/s);
                                
                                if (nodesMatch && connectionsMatch) {
                                    nodes = JSON.parse(nodesMatch[1]);
                                    connections = JSON.parse(connectionsMatch[1]);
                                    
                                    // Actualizar contador de nodos
                                    nodeCounter = nodes.length;
                                    
                                    // Renderizar todo
                                    renderAll();
                                    updateCounters();
                                    
                                    alert('Mapa cargado correctamente');
                                    return;
                                }
                            } catch (error) {
                                console.error('Error al parsear datos:', error);
                            }
                        }
                    }
                    
                    alert('No se pudieron cargar los datos del mapa desde el archivo HTML');
                } catch (error) {
                    console.error('Error al cargar archivo:', error);
                    alert('Error al cargar el archivo HTML');
                }
            };
            reader.readAsText(file);
        }

        // Renderizar nodo en el workspace
        function renderNode(node) {
            const nodeElement = document.createElement('div');
            nodeElement.className = `node node-${node.type} bg-${node.bgColor} text-${node.textColor} border-${node.borderColor}`;
            nodeElement.id = node.id;
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            
            nodeElement.innerHTML = `
                <div class="node-title">${node.title}</div>
                ${node.subtitle ? `<div class="node-subtitle">${node.subtitle}</div>` : ''}
            `;

            // Hacer arrastrable
            makeDraggable(nodeElement, node);

            // Evento click simple para selecci√≥n
            nodeElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                if (deleteMode) {
                    deleteNode(node.id);
                    return;
                }
                
                if (connectionMode && sourceNodeId && sourceNodeId !== node.id) {
                    createConnection(sourceNodeId, node.id);
                    setConnectionMode(false);
                } else if (connectionMode && !sourceNodeId) {
                    sourceNodeId = node.id;
                    connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el nodo destino';
                }
            });

            // Evento doble click para mostrar opciones
            nodeElement.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                if (!connectionMode && !deleteMode) {
                    showEditForm(node.id);
                }
            });

            workspace.appendChild(nodeElement);
        }

        // Hacer nodo arrastrable
        function makeDraggable(element, node) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', startDrag);

            function startDrag(e) {
                if (e.target.classList.contains('node-btn') || deleteMode) return;
                
                e.preventDefault();
                isDragging = true;
                element.classList.add('dragging');
                
                startX = e.clientX;
                startY = e.clientY;
                initialX = element.offsetLeft;
                initialY = element.offsetTop;
                
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
            }

            function onDrag(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newX = initialX + dx;
                let newY = initialY + dy;

                // Mantener dentro de los l√≠mites
                newX = Math.max(6.5, Math.min(newX, workspace.offsetWidth - element.offsetWidth - 6.5));
                newY = Math.max(6.5, Math.min(newY, workspace.offsetHeight - element.offsetHeight - 6.5));

                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
                
                node.x = newX;
                node.y = newY;

                updateConnections();
            }

            function stopDrag() {
                isDragging = false;
                element.classList.remove('dragging');
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
            }
        }

        // Iniciar modo conexi√≥n
        function startConnection() {
            if (nodes.length < 2) {
                alert('Necesitas al menos 2 nodos para crear conexiones');
                return;
            }
            setConnectionMode(true);
            sourceNodeId = null;
            nodeInfo.innerHTML = '<p>üîó Selecciona el primer nodo para conectar</p>';
        }

        // Activar/desactivar modo conexi√≥n
        function setConnectionMode(active) {
            connectionMode = active;
            if (active) {
                connectionModeDiv.style.display = 'block';
                connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el primer nodo';
                // Desactivar modo eliminaci√≥n si est√° activo
                if (deleteMode) {
                    toggleDeleteMode();
                }
            } else {
                connectionModeDiv.style.display = 'none';
                sourceNodeId = null;
            }
        }

        // Crear conexi√≥n entre nodos
        function createConnection(fromId, toId) {
            // Evitar conexiones duplicadas
            const existingConnection = connections.find(conn => 
                (conn.from === fromId && conn.to === toId) || 
                (conn.from === toId && conn.to === fromId)
            );

            if (existingConnection) {
                alert('Estos nodos ya est√°n conectados');
                return;
            }

            if (fromId === toId) {
                alert('No puedes conectar un nodo consigo mismo');
                return;
            }

            connections.push({ from: fromId, to: toId });
            renderConnection(fromId, toId);
            updateCounters();
        }

        // Renderizar conexi√≥n
        function renderConnection(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const toNode = nodes.find(n => n.id === toId);

            if (!fromNode || !toNode) return;

            // Crear l√≠nea
            const line = document.createElement('div');
            line.className = 'connection';
            line.id = 'conn-' + fromId + '-' + toId;

            // Crear flecha
            const arrow = document.createElement('div');
            arrow.className = 'connection-arrow';
            arrow.id = 'arrow-' + fromId + '-' + toId;

            workspace.appendChild(line);
            workspace.appendChild(arrow);

            updateConnection(fromId, toId);
        }

        // Actualizar posici√≥n de conexi√≥n
        function updateConnection(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const toNode = nodes.find(n => n.id === toId);
            const line = document.getElementById('conn-' + fromId + '-' + toId);
            const arrow = document.getElementById('arrow-' + fromId + '-' + toId);

            if (!fromNode || !toNode || !line || !arrow) return;

            const fromElement = document.getElementById(fromId);
            const toElement = document.getElementById(toId);

            if (!fromElement || !toElement) return;

            const fromX = fromNode.x + fromElement.offsetWidth / 2;
            const fromY = fromNode.y + fromElement.offsetHeight / 2;
            const toX = toNode.x + toElement.offsetWidth / 2;
            const toY = toNode.y + toElement.offsetHeight / 2;

            const dx = toX - fromX;
            const dy = toY - fromY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            line.style.width = length + 'px';
            line.style.left = fromX + 'px';
            line.style.top = fromY + 'px';
            line.style.transform = 'rotate(' + angle + 'deg)';

            arrow.style.left = toX + 'px';
            arrow.style.top = toY + 'px';
            arrow.style.transform = 'rotate(' + angle + 'deg)';
        }

        // Actualizar todas las conexiones
        function updateConnections() {
            connections.forEach(conn => {
                updateConnection(conn.from, conn.to);
            });
        }

        // Actualizar contadores
        function updateCounters() {
            document.getElementById('nodesCount').textContent = nodes.length;
            document.getElementById('connectionsCount').textContent = connections.length;
        }

        // Eliminar nodo
        function deleteNode(nodeId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este nodo?')) return;

            // Eliminar conexiones relacionadas
            connections = connections.filter(conn => 
                conn.from !== nodeId && conn.to !== nodeId
            );

            // Eliminar nodo
            nodes = nodes.filter(n => n.id !== nodeId);
            
            // Re-renderizar
            renderAll();
            updateCounters();
            
            // Desactivar modo eliminaci√≥n despu√©s de eliminar
            toggleDeleteMode();
        }

        // Limpiar todo
        function clearAll() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar todo?')) return;
            
            nodes = [];
            connections = [];
            renderAll();
            updateCounters();
        }

        // Renderizar todo
        function renderAll() {
            workspace.innerHTML = '';
            nodes.forEach(node => renderNode(node));
            connections.forEach(conn => renderConnection(conn.from, conn.to));
            updateWorkspaceTransform();
        }

        // Generar c√≥digo para exportar - COMPLETAMENTE RESPONSIVO
        function generateExportCode() {
            const exportHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${mapTitle.textContent}</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .workspace-container {
            position: relative;
            width: 100%;
            height: 800px;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
        }

        .workspace {
            position: relative;
            width: 3500px;
            height: 2400px;
            background: white;
        }

        .node {
            position: absolute;
            min-width: 80px;
            max-width: 120px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 1px solid #e0e0e0;
            user-select: none;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 12px;
        }

        .node:hover {
            transform: scale(1.03);
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        }

        .node-main {
            border-color: #2196F3;
            background: #f8fdff;
        }

        .node-topic {
            border-color: #FF9800;
            background: #fffbf5;
        }

        .node-subtopic {
            border-color: #9C27B0;
            background: #fcf5ff;
        }

        .node-title {
            font-family: 'EB Garamond', 'Garamond', 'Times New Roman', serif;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            line-height: 1.2;
            word-wrap: break-word;
        }

        .node-subtitle {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 500;
            font-size: 11px;
            margin-bottom: 6px;
            font-style: italic;
            line-height: 1.2;
            opacity: 0.8;
            word-wrap: break-word;
        }

        .text-black { color: #000000 !important; }
        .text-gray { color: #666666 !important; }
        .text-white { color: #ffffff !important; }

        .bg-white { background: #ffffff !important; }
        .bg-light { background: #f8f9fa !important; }
        .bg-dark { 
            background: #2c3e50 !important; 
            border-color: #34495e !important;
        }

        .border-none { border-color: transparent !important; }
        .border-red { border-color: #dc3545 !important; }
        .border-blue { border-color: #007bff !important; }
        .border-green { border-color: #28a745 !important; }
        .border-purple { border-color: #6f42c1 !important; }
        .border-orange { border-color: #fd7e14 !important; }

        .connection {
            position: absolute;
            background: #95a5a6;
            height: 2px;
            transform-origin: 0 0;
            pointer-events: none;
            z-index: 5;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #95a5a6;
            transform-origin: center;
            pointer-events: none;
            z-index: 6;
        }

        .info-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .info-panel h3 {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Modal para descripci√≥n */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            padding: 0;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-title {
            font-family: 'EB Garamond', serif;
            font-size: 22px;
            margin-bottom: 8px;
            color: #333;
        }

        .modal-subtitle {
            font-family: 'EB Garamond', serif;
            font-size: 14px;
            margin-bottom: 15px;
            color: #666;
            font-style: italic;
        }

        .modal-author {
            font-family: 'Calibri', sans-serif;
            font-size: 13px;
            margin-bottom: 15px;
            color: #888;
            font-style: italic;
        }

        .modal-image {
            max-width: 100%;
            max-height: 200px;
            margin: 15px 0;
            border-radius: 6px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-description {
            font-family: 'Calibri', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* MEDIA QUERIES PARA RESPONSIVIDAD */
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
                padding: 12px;
            }
            
            .workspace-container {
                height: 600px;
            }
        }

        @media (max-width: 992px) {
            .workspace-container {
                height: 500px;
            }
            
            .node {
                min-width: 70px;
                max-width: 100px;
                padding: 6px;
                font-size: 11px;
            }
            
            .node-title {
                font-size: 12px;
            }
            
            .node-subtitle {
                font-size: 10px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 10px;
                border-radius: 6px;
            }
            
            h1 {
                font-size: 1em;
                margin-bottom: 12px;
            }
            
            .workspace-container {
                height: 400px;
                min-height: 400px;
            }
            
            .workspace {
                min-width: 600px;
                min-height: 400px;
            }
            
            .node {
                min-width: 60px;
                max-width: 90px;
                padding: 5px;
                font-size: 10px;
            }
            
            .node-title {
                font-size: 11px;
            }
            
            .node-subtitle {
                font-size: 9px;
            }
            
            .info-panel {
                padding: 12px;
                font-size: 13px;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 20px;
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .workspace-container {
                height: 350px;
                min-height: 350px;
            }
            
            .workspace {
                min-width: 500px;
                min-height: 350px;
            }
            
            .node {
                min-width: 55px;
                max-width: 80px;
                padding: 4px;
                font-size: 9px;
            }
            
            .node-title {
                font-size: 10px;
            }
            
            .node-subtitle {
                font-size: 8px;
            }
            
            .modal-content {
                margin: 5% auto;
                padding: 15px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .modal-subtitle {
                font-size: 12px;
            }
            
            .modal-description {
                font-size: 12px;
                padding: 12px;
            }
        }

        @media (max-width: 400px) {
            .workspace-container {
                height: 300px;
                min-height: 300px;
            }
            
            .workspace {
                min-width: 400px;
                min-height: 300px;
            }
            
            h1 {
                font-size: 0.9em;
            }
            
            .info-panel {
                font-size: 12px;
                padding: 10px;
            }
        }

        /* Scrollbar personalizado para el workspace */
        .workspace-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .workspace-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .workspace-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .workspace-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    <\/style>
</head>
<body>
    <div class="container">
        <h1>${mapTitle.textContent}</h1>
        
        <div class="workspace-container">
            <div class="workspace" id="workspace"></div>
        </div>

        <!-- Modal para descripci√≥n -->
        <div id="descriptionModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal()">&times;</button>
                <h2 class="modal-title" id="modalTitle"></h2>
                <h3 class="modal-subtitle" id="modalSubtitle"></h3>
                <div class="modal-author" id="modalAuthor"></div>
                <img id="modalImage" class="modal-image" style="display: none;" alt="Imagen del nodo">
                <div class="modal-description" id="modalDescription"></div>
            </div>
        </div>

        <div class="info-panel">
            <h3>INFORMACI√ìN DEL MAPA</h3>
            <p>Total de nodos: ${nodes.length} | Conexiones: ${connections.length}</p>
            <p>Haz click en cualquier nodo para ver m√°s informaci√≥n</p>
        </div>
    </div>

    <script>
        // Datos del mapa
        const nodes = ${JSON.stringify(nodes)};
        const connections = ${JSON.stringify(connections)};
        
        function loadMap() {
            const workspace = document.getElementById('workspace');
            
            // Cargar nodos
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node node-' + node.type + ' bg-' + node.bgColor + ' text-' + node.textColor + ' border-' + (node.borderColor || 'blue');
                nodeElement.style.left = node.x + 'px';
                nodeElement.style.top = node.y + 'px';
                nodeElement.innerHTML = 
                    '<div class="node-title">' + node.title + '</div>' + 
                    (node.subtitle ? '<div class="node-subtitle">' + node.subtitle + '</div>' : '');
                
                // Hacer clickable para abrir modal
                nodeElement.addEventListener('click', function() {
                    showDescriptionModal(node.id);
                });
                
                workspace.appendChild(nodeElement);
            });

            // Cargar conexiones
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const fromX = fromNode.x + 40;
                    const fromY = fromNode.y + 20;
                    const toX = toNode.x + 40;
                    const toY = toNode.y + 20;
                    
                    const dx = toX - fromX;
                    const dy = toY - fromY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    const line = document.createElement('div');
                    line.className = 'connection';
                    line.style.width = length + 'px';
                    line.style.left = fromX + 'px';
                    line.style.top = fromY + 'px';
                    line.style.transform = 'rotate(' + angle + 'deg)';
                    
                    const arrow = document.createElement('div');
                    arrow.className = 'connection-arrow';
                    arrow.style.left = toX + 'px';
                    arrow.style.top = toY + 'px';
                    arrow.style.transform = 'rotate(' + angle + 'deg)';
                    
                    workspace.appendChild(line);
                    workspace.appendChild(arrow);
                }
            });
        }

        function showDescriptionModal(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            document.getElementById('modalTitle').textContent = node.title;
            document.getElementById('modalSubtitle').textContent = node.subtitle || 'Sin subt√≠tulo';
            document.getElementById('modalAuthor').textContent = node.author ? 'Autor: ' + node.author : 'Autor no especificado';
            document.getElementById('modalDescription').textContent = node.description || 'Sin descripci√≥n disponible.';
            
            const modalImage = document.getElementById('modalImage');
            if (node.image) {
                modalImage.src = node.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            document.getElementById('descriptionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('descriptionModal').style.display = 'none';
        }

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('descriptionModal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        // Cargar el mapa cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', loadMap);
    <\/script>
</body>
</html>`;

            document.getElementById('exportCode').value = exportHTML;
        }

        // Copiar al portapapeles
        function copyToClipboard() {
            const exportCode = document.getElementById('exportCode');
            exportCode.select();
            navigator.clipboard.writeText(exportCode.value).then(() => {
                alert('‚úÖ C√≥digo copiado al portapapeles');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ C√≥digo copiado al portapapeles');
            });
        }

        // Descargar como HTML
        function downloadHTML() {
            const exportCode = document.getElementById('exportCode').value;
            const blob = new Blob([exportCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mapa-interactivo.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úÖ Archivo HTML descargado correctamente');
        }

        // Funciones de zoom
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.1, 2);
            updateWorkspaceTransform();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
            updateWorkspaceTransform();
        }

        function resetZoom() {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateWorkspaceTransform();
        }

        function updateWorkspaceTransform() {
            workspace.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
        }

        // Inicializar
        renderAll();
        updateCounters();

        // Agregar algunos nodos de ejemplo al inicio
        setTimeout(() => {
            const node1 = {
                id: 'node-1',
                title: 'Arte y Ciencias Sociales',
                subtitle: 'Intersecciones disciplinares',
                author: 'Varios autores',
                description: 'Este mapa explora las conexiones entre el arte y las ciencias sociales, examinando c√≥mo se influyen mutuamente.',
                image: null,
                type: 'main',
                x: 100,
                y: 100,
                bgColor: 'white',
                textColor: 'black',
                borderColor: 'blue'
            };

            const node2 = {
                id: 'node-2',
                title: 'Antropolog√≠a Visual',
                subtitle: 'Estudio cultural de las im√°genes',
                author: 'Margaret Mead',
                description: 'La antropolog√≠a visual estudia c√≥mo las sociedades humanas producen, interpretan y utilizan las im√°genes visuales.',
                image: null,
                type: 'topic',
                x: 300,
                y: 200,
                bgColor: 'white',
                textColor: 'black',
                borderColor: 'orange'
            };

            nodes.push(node1, node2);
            renderAll();
            updateCounters();
        }, 500);
    </script>
</body>
</html>
