<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Mapas Conceptuales - V6 Estabe</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsplumb/2.15.6/js/jsplumb.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- ESTILOS GENERALES --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; }
        
        /* Barra Superior (Pestañas y Herramientas) */
        #barra-superior {
            height: 60px; background: #2c3e50; color: white; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; position: relative;
        }
        
        .pestana {
            padding: 10px 20px; background: #34495e; margin-right: 5px; cursor: pointer; border-radius: 5px 5px 0 0; opacity: 0.7; transition: 0.3s;
        }
        .pestana.activa { background: #f4f4f9; color: #333; opacity: 1; font-weight: bold; }
        .btn-add-tab { padding: 5px 10px; background: #27ae60; border-radius: 3px; cursor: pointer; margin-right: 20px; }

        /* Barra de Herramientas Flotante */
        #toolbar {
            position: absolute; top: 70px; left: 20px; width: 220px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); z-index: 900;
        }
        .grupo-herramienta { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .grupo-herramienta:last-child { border-bottom: none; }
        .btn { display: block; width: 100%; padding: 8px; margin-bottom: 5px; border: none; cursor: pointer; text-align: left; border-radius: 4px; font-size: 14px; transition: 0.2s; }
        .btn i { margin-right: 8px; width: 20px; text-align: center; }
        
        .btn-crear { background: #3498db; color: white; } .btn-crear:hover { background: #2980b9; }
        .btn-borrar { background: #e74c3c; color: white; } .btn-borrar:hover { background: #c0392b; }
        .btn-conectar { background: #f39c12; color: white; } .btn-conectar:hover { background: #d35400; }
        .btn-conectar.activo { background: #d35400; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .btn-exportar { background: #27ae60; color: white; margin-top: 10px; }

        label { font-size: 12px; color: #666; display: block; margin-top: 5px; }
        input[type="color"], input[type="range"], select { width: 100%; margin-top: 2px; }

        /* --- EL LIENZO (Donde van los nodos) --- */
        #lienzo-container {
            position: absolute; top: 60px; left: 0; right: 0; bottom: 0; overflow: auto; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px;
        }
        
        .lienzo-mapa {
            width: 3000px; height: 3000px; position: relative; /* Lienzo gigante */
        }

        /* --- LOS NODOS --- */
        .nodo {
            position: absolute; width: 180px; min-height: 80px; background: white; border: 2px solid #34495e; border-radius: 10px; padding: 0; box-shadow: 3px 3px 10px rgba(0,0,0,0.1); cursor: move; display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Estados del nodo */
        .nodo.seleccionado { border: 2px solid #3498db; box-shadow: 0 0 15px rgba(52, 152, 219, 0.6); z-index: 500; }
        .nodo.editando { border: 2px dashed #27ae60; cursor: text; }

        /* Partes del nodo */
        .nodo-header { background: #ecf0f1; padding: 5px; cursor: pointer; text-align: center; border-bottom: 1px solid #ddd; }
        .nodo-titulo { font-weight: bold; font-size: 16px; min-height: 20px; outline: none; padding: 2px;}
        .nodo-subtitulo { font-size: 12px; color: #7f8c8d; min-height: 15px; outline: none; padding: 2px;}
        
        .nodo-body { padding: 10px; font-size: 13px; color: #2c3e50; flex-grow: 1; outline: none; }
        
        .nodo-img-container { text-align: center; padding: 5px; display: none; }
        .nodo-img-container img { max-width: 100%; height: auto; border-radius: 4px; }

        /* Conector (Punto para arrastrar líneas - opcional visualmente) */
        .conector-punto { width: 10px; height: 10px; background: #7f8c8d; position: absolute; bottom: -5px; right: -5px; border-radius: 50%; cursor: crosshair; }

    </style>
</head>
<body>

    <div id="barra-superior">
        <div id="lista-pestanas" style="display:flex;">
            <div class="pestana activa" onclick="cambiarPestana(0)">Mapa 1</div>
        </div>
        <div class="btn-add-tab" onclick="nuevaPestana()">+</div>
        <div style="flex-grow:1;"></div>
        <div style="font-size: 12px; color: #ccc;">Doble clic para editar texto | Clic para seleccionar</div>
    </div>

    <div id="toolbar">
        <div class="grupo-herramienta">
            <button class="btn btn-crear" onclick="crearNodo()"><i class="fas fa-plus-circle"></i> Nuevo Nodo</button>
            <button class="btn btn-borrar" onclick="borrarSeleccionado()"><i class="fas fa-trash"></i> Borrar Nodo</button>
        </div>
        
        <div class="grupo-herramienta">
            <button id="btn-modo-conectar" class="btn btn-conectar" onclick="toggleModoConectar()"><i class="fas fa-link"></i> Modo Conectar</button>
            <label style="color:#e67e22; display:none;" id="aviso-conectar">Arrastra de un nodo a otro</label>
        </div>

        <div class="grupo-herramienta" id="panel-edicion" style="opacity: 0.5; pointer-events: none;">
            <strong>Estilo del Nodo</strong>
            <label>Color de Fondo</label>
            <input type="color" id="color-fondo" onchange="cambiarEstilo('fondo', this.value)">
            
            <label>Color de Texto</label>
            <input type="color" id="color-texto" onchange="cambiarEstilo('texto', this.value)">
            
            <label>Tamaño Fuente</label>
            <input type="range" min="10" max="30" value="14" id="tamano-fuente" oninput="cambiarEstilo('tamano', this.value)">
            
            <label>Imagen (URL)</label>
            <input type="text" id="url-imagen" placeholder="Pegar enlace imagen..." style="width:95%;" onchange="agregarImagen(this.value)">
        </div>

        <button class="btn btn-exportar" onclick="exportarMapa()"><i class="fas fa-file-export"></i> Exportar HTML</button>
    </div>

    <div id="lienzo-container">
        <div id="mapa-0" class="lienzo-mapa"></div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        var nodoSeleccionado = null;
        var pestanaActual = 0;
        var contadorNodos = 0;
        var modoConectar = false;
        var jsPlumbInstance = null;

        // --- INICIALIZACIÓN ---
        $(document).ready(function() {
            inicializarJsPlumb();
            
            // Clic en el fondo para deseleccionar
            $(document).on('click', function(e) {
                if ($(e.target).closest('.nodo').length === 0 && $(e.target).closest('#toolbar').length === 0 && $(e.target).closest('.pestana').length === 0) {
                    deseleccionarTodo();
                }
            });

            // Tecla suprimir para borrar
            $(document).on('keydown', function(e) {
                if (e.key === "Delete" && nodoSeleccionado && !$(e.target).is('[contenteditable="true"]')) {
                    borrarSeleccionado();
                }
            });
        });

        function inicializarJsPlumb() {
            jsPlumbInstance = jsPlumb.getInstance({
                Connector: ["Bezier", { curviness: 50 }],
                DragOptions: { cursor: 'pointer', zIndex: 2000 },
                PaintStyle: { stroke: '#7f8c8d', strokeWidth: 3 },
                Endpoint: ["Dot", { radius: 5 }],
                EndpointStyle: { fill: "#7f8c8d" },
                Container: "mapa-" + pestanaActual
            });
        }

        // --- GESTIÓN DE PESTAÑAS ---
        function nuevaPestana() {
            var id = $(".pestana").length;
            $("#lista-pestanas").append(`<div class="pestana" onclick="cambiarPestana(${id})">Mapa ${id + 1}</div>`);
            $("#lienzo-container").append(`<div id="mapa-${id}" class="lienzo-mapa" style="display:none;"></div>`);
            cambiarPestana(id);
        }

        function cambiarPestana(id) {
            $(".pestana").removeClass("activa");
            $(".pestana").eq(id).addClass("activa");
            $(".lienzo-mapa").hide();
            $("#mapa-" + id).show();
            pestanaActual = id;
            deseleccionarTodo();
            
            // Reiniciar jsPlumb para el nuevo contenedor
            jsPlumbInstance.setContainer("mapa-" + id);
        }

        // --- CREACIÓN Y GESTIÓN DE NODOS ---
        function crearNodo() {
            contadorNodos++;
            var idNodo = `nodo-${pestanaActual}-${contadorNodos}`;
            
            var html = `
                <div id="${idNodo}" class="nodo" style="top:100px; left:300px;">
                    <div class="nodo-header">
                        <div class="nodo-titulo" contenteditable="false">Título</div>
                        <div class="nodo-subtitulo" contenteditable="false">Subtítulo</div>
                    </div>
                    <div class="nodo-img-container"><img src="" alt=""></div>
                    <div class="nodo-body" contenteditable="false">Detalle del concepto...</div>
                </div>
            `;

            $("#mapa-" + pestanaActual).append(html);
            var $nuevoNodo = $("#" + idNodo);
            
            asignarEventos($nuevoNodo);
            hacerConectable($nuevoNodo);
            seleccionarNodo($nuevoNodo);
        }

        function asignarEventos($nodo) {
            // 1. Draggable (Mover)
            $nodo.draggable({
                containment: "parent",
                start: function() { seleccionarNodo($(this)); },
                drag: function() { jsPlumbInstance.repaintEverything(); } // Actualizar líneas al mover
            });

            // 2. Click (Seleccionar)
            $nodo.off('click').on('click', function(e) {
                e.stopPropagation();
                if (modoConectar) return; // Si estamos conectando, no seleccionamos normal
                seleccionarNodo($(this));
            });

            // 3. Doble Click (Editar Texto)
            $nodo.off('dblclick').on('dblclick', function(e) {
                e.stopPropagation();
                activarEdicion($(this));
            });
        }

        function hacerConectable($nodo) {
            // Configurar como origen de conexión
            jsPlumbInstance.makeSource($nodo, {
                filter: ".nodo", // Se puede arrastrar desde cualquier parte del nodo
                anchor: "Continuous",
                connectorStyle: { stroke: "#34495e", strokeWidth: 2, outlineStroke: "transparent", outlineWidth: 4 },
                connectionType:"basic",
                extract:{
                    "action":"the-action"
                },
                maxConnections: -1,
                onMaxConnections: function (info, e) {
                    alert("Maximum connections (" + info.maxConnections + ") reached");
                }
            });

            // Configurar como destino
            jsPlumbInstance.makeTarget($nodo, {
                dropOptions: { hoverClass: "dragHover" },
                anchor: "Continuous",
                allowLoopback: false
            });
        }

        // --- LÓGICA DE SELECCIÓN (LA CLAVE DE TU PROBLEMA) ---
        function seleccionarNodo($nodo) {
            // Si ya está seleccionado, no hacer nada (evita parpadeos)
            if (nodoSeleccionado && nodoSeleccionado[0] === $nodo[0]) return;

            deseleccionarTodo(); // Limpia el anterior

            nodoSeleccionado = $nodo;
            nodoSeleccionado.addClass('seleccionado');
            
            // Activar panel de edición
            $("#panel-edicion").css("opacity", "1").css("pointer-events", "auto");
            
            // Cargar valores en el panel
            $("#color-fondo").val(rgbToHex(nodoSeleccionado.css("background-color")));
            $("#color-texto").val(rgbToHex(nodoSeleccionado.css("color")));
        }

        function deseleccionarTodo() {
            if (nodoSeleccionado) {
                // Desactivar contenteditable de los hijos
                nodoSeleccionado.find('[contenteditable]').attr('contenteditable', 'false');
                nodoSeleccionado.removeClass('seleccionado').removeClass('editando');
                nodoSeleccionado.draggable("enable"); // Reactivar arrastre si estaba editando
            }
            nodoSeleccionado = null;
            $("#panel-edicion").css("opacity", "0.5").css("pointer-events", "none");
        }

        function borrarSeleccionado() {
            if (!nodoSeleccionado) return;
            
            // Borrar conexiones asociadas primero
            jsPlumbInstance.remove(nodoSeleccionado); // Esto borra el nodo y sus líneas del DOM y de jsPlumb
            nodoSeleccionado = null;
            deseleccionarTodo();
        }

        // --- EDICIÓN DE TEXTO ---
        function activarEdicion($nodo) {
            seleccionarNodo($nodo);
            $nodo.addClass('editando');
            $nodo.draggable("disable"); // Desactivar arrastre para poder seleccionar texto

            // Hacer editables las partes de texto
            var editables = $nodo.find('.nodo-titulo, .nodo-subtitulo, .nodo-body');
            editables.attr('contenteditable', 'true');
            
            // Poner foco en el título
            $nodo.find('.nodo-titulo').focus();

            // Salir de edición al perder el foco (blur)
            // Usamos un timeout para no salir si cambiamos entre titulo y cuerpo del mismo nodo
            /* Nota: La lógica simple es que el usuario haga clic afuera para terminar.
               Dejamos el contenteditable activo hasta que deseleccione.
            */
        }

        // --- PERSONALIZACIÓN Y HERRAMIENTAS ---
        function cambiarEstilo(tipo, valor) {
            if (!nodoSeleccionado) return;
            
            if (tipo === 'fondo') nodoSeleccionado.css('background-color', valor);
            if (tipo === 'texto') nodoSeleccionado.css('color', valor);
            if (tipo === 'tamano') nodoSeleccionado.find('.nodo-body').css('font-size', valor + 'px');
        }

        function agregarImagen(url) {
            if (!nodoSeleccionado || !url) return;
            var container = nodoSeleccionado.find('.nodo-img-container');
            container.find('img').attr('src', url);
            container.show();
            jsPlumbInstance.repaintEverything(); // Recalcular conexiones por el cambio de tamaño
            $("#url-imagen").val(""); // Limpiar input
        }

        function toggleModoConectar() {
            modoConectar = !modoConectar;
            if (modoConectar) {
                $("#btn-modo-conectar").addClass("activo");
                $("#aviso-conectar").show();
                // Desactivar draggable para facilitar la conexión desde cualquier punto
                $(".nodo").draggable("disable");
            } else {
                $("#btn-modo-conectar").removeClass("activo");
                $("#aviso-conectar").hide();
                $(".nodo").draggable("enable");
            }
        }

        // Ayuda para convertir colores a hex para el input color
        function rgbToHex(rgb) {
            if (!rgb || rgb === 'rgba(0, 0, 0, 0)') return '#ffffff';
            if (rgb.indexOf('#') === 0) return rgb;
            rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!rgb) return "#ffffff";
            function hex(x) { return ("0" + parseInt(x).toString(16)).slice(-2); }
            return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
        }

        // --- EXPORTAR ---
        function exportarMapa() {
            deseleccionarTodo();
            
            // Clonar el mapa actual
            var $mapaClone = $("#mapa-" + pestanaActual).clone();
            
            // Limpiar clases de jsPlumb que pueden dar error fuera
            $mapaClone.find('.jtk-endpoint, .jtk-connector').remove(); 
            // NOTA: Para exportar conexiones SVG de jsPlumb estáticas es complejo. 
            // En esta versión simplificada de exportación, exportaremos los NODOS como HTML limpio.
            // Si necesitas las flechas en el exportado estático, requiere capturar el SVG.
            // Para fines educativos simples, exportaremos una versión "Lectura" con las líneas si es posible, 
            // pero jsPlumb dibuja líneas absolutas al body o contenedor.
            
            // Solución de exportación simple: Generar un archivo HTML con el contenido actual
            // pero inyectando los scripts necesarios para que se vean las líneas al abrirlo.
            
            var contenidoHTML = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Mapa Exportado</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        .nodo { position: absolute; background: white; border: 2px solid #34495e; border-radius: 10px; padding: 10px; width: 180px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .nodo-titulo { font-weight: bold; text-align: center; margin-bottom: 5px; }
        .nodo-subtitulo { font-size: 0.8em; text-align: center; color: #777; margin-bottom: 5px; }
        .nodo-img-container img { max-width: 100%; }
        /* Ajuste para móviles */
        @media (max-width: 600px) {
            .nodo { position: relative !important; left: auto !important; top: auto !important; margin-bottom: 20px; width: 100%; }
        }
    </style>
</head>
<body>
    <h1>Mapa Conceptual</h1>
    <div style="position:relative; height: 100vh;">
        ${$("#mapa-" + pestanaActual).html()} 
    </div>
    </body>
</html>`;

            var blob = new Blob([contenidoHTML], {type: "text/html;charset=utf-8"});
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "mapa_exportado.html";
            link.click();
        }

    </script>
</body>
</html>
