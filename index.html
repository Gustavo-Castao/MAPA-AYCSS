<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Mapas Conceptuales Pro (v2)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --border-color: #ccc;
            --accent: #4a90e2;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: var(--bg-color); }
        
        /* UI Layout */
        #toolbar {
            position: fixed; top: 10px; left: 10px; width: 260px;
            background: var(--panel-bg); padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
        
        .control-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        label { font-size: 12px; color: #666; font-weight: bold; }
        input[type="color"] { width: 100%; height: 30px; border: none; cursor: pointer; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        button {
            padding: 10px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #357abd; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-danger { background: #e74c3c; color: white; }
        
        /* Canvas Area */
        #workspace {
            width: 100vw; height: 100vh; position: relative;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* SVG Layer for Lines */
        #connections-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Allows clicking through to nodes */
            z-index: 0;
        }

        /* Nodes */
        .node {
            position: absolute; min-width: 120px; min-height: 60px;
            padding: 10px; border: 1px solid #aaa; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: grab; user-select: none; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            text-align: center; resize: both; overflow: auto;
        }
        
        .node.selected {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
            z-index: 20;
        }

        .node-content {
            width: 100%; height: 100%; outline: none; cursor: text;
        }

        /* Mode Indicators */
        #mode-indicator {
            margin-top: 10px; font-size: 12px; color: #d35400; font-weight: bold; display: none;
        }

    </style>
</head>
<body>

    <div id="toolbar">
        <h3>Propiedades</h3>
        
        <div class="control-group">
            <button onclick="createNode()" class="btn-primary">+ Nuevo Nodo</button>
            <button onclick="toggleLinkMode()" id="btn-link" class="btn-secondary">游댕 Vincular Nodos</button>
            <div id="mode-indicator">Modo Vincular: Selecciona 2 nodos</div>
        </div>

        <hr style="width:100%; border:0; border-top:1px solid #eee;">

        <div class="control-group">
            <label>Color Fondo</label>
            <input type="color" id="bg-color" value="#ffffff" onchange="updateSelectedNode('bg')">
        </div>
        <div class="control-group">
            <label>Color Texto</label>
            <input type="color" id="text-color" value="#000000" onchange="updateSelectedNode('color')">
        </div>
        <div class="control-group">
            <label>Tama침o Texto</label>
            <input type="range" id="font-size" min="10" max="40" value="16" oninput="updateSelectedNode('size')">
            <span id="font-size-value" style="font-size: 12px; text-align: right;">16px</span>
        </div>

        <button onclick="deleteSelected()" class="btn-danger" style="margin-top:10px;">游딈 Eliminar Seleccionado</button>
        
        <hr style="width:100%; border:0; border-top:1px solid #eee;">
        
        <h3>Exportar</h3>
        <button onclick="exportPNG()" class="btn-secondary">游닝 Guardar PNG</button>
        <button onclick="exportHTML()" class="btn-secondary">游 Guardar HTML (Editable)</button>
    </div>

    <div id="workspace">
        <svg id="connections-layer"></svg>
        </div>

    <script>
        // --- ESTADO DE LA APLICACI칍N ---
        let nodes = [];
        let connections = [];
        let selectedNodeId = null;
        let isLinkMode = false;
        let linkSourceId = null;

        const workspace = document.getElementById('workspace');
        const svgLayer = document.getElementById('connections-layer');

        // --- GESTI칍N DE NODOS ---

        // Generador de ID robusto para evitar conflictos
        function generateId() {
            return 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }

        function createNode(loadData = null) {
            const id = loadData ? loadData.id : generateId();
            const x = loadData ? loadData.x : 300 + (nodes.length * 10);
            const y = loadData ? loadData.y : 100 + (nodes.length * 10);
            const text = loadData ? loadData.text : "Nuevo Concepto";
            const style = loadData ? loadData.style : { bg: '#ffffff', color: '#000000', size: '16px' };

            const node = document.createElement('div');
            node.className = 'node';
            node.id = id;
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            node.style.backgroundColor = style.bg;
            node.style.color = style.color;
            node.style.fontSize = style.size;

            // Contenido editable
            const content = document.createElement('div');
            content.className = 'node-content';
            content.contentEditable = true;
            content.innerText = text;
            node.appendChild(content);

            // --- CORRECCI칍N CLAVE: SEPARACI칍N DE SELECCI칍N Y DRAG ---
            node.onmousedown = (e) => {
                // 1. Siempre seleccionar/actualizar UI en mousedown, sin importar d칩nde
                selectNode(e, node);
                
                // 2. Si el objetivo es el 치rea de texto editable, no arrastrar (permitir edici칩n)
                if (e.target.className === 'node-content') {
                    return; 
                }

                // 3. Si el clic fue en el borde, iniciar arrastre
                e.preventDefault(); // Previene selecci칩n de texto del navegador
                startDragLogic(e, node);
            };
            // -----------------------------------------------------------------

            workspace.appendChild(node);
            
            // Guardar en array l칩gico
            if(!loadData) {
                // Asegura que el tama침o se guarde correctamente despu칠s de la carga inicial
                node.style.width = '120px'; 
                node.style.height = '60px'; 
                nodes.push({ id, x, y, text, style, width: '120px', height: '60px' });
            } else {
                node.style.width = loadData.width;
                node.style.height = loadData.height;
                nodes.push(loadData);
            }
            selectNode(null, node);

            // Event listener para redimensionamiento del nodo (HTML resize:both)
            new ResizeObserver(entries => {
                // Actualizar las conexiones al terminar de redimensionar
                renderConnections();
                // Actualizar las dimensiones en el modelo de datos
                const resizedNode = nodes.find(n => n.id === id);
                if (resizedNode) {
                    resizedNode.width = node.style.width;
                    resizedNode.height = node.style.height;
                }
            }).observe(node);
        }

        // --- SELECCI칍N Y EDICI칍N ---

        function selectNode(e, node) {
            if(e) e.stopPropagation();
            
            // Si estamos en modo vincular
            if (isLinkMode) {
                handleLinkClick(node.id);
                return;
            }

            // Si ya est치 seleccionado, no hacer nada (o permitir deselecci칩n si no hay drag)
            if (selectedNodeId === node.id && !e) return; 

            // UI Feedback: Deseleccionar todos y seleccionar este
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            node.classList.add('selected');
            selectedNodeId = node.id;

            // Cargar propiedades en el panel
            const nodeData = nodes.find(n => n.id === node.id);
            if(nodeData) {
                // Asegura que los colores se muestren como hex para el input type="color"
                document.getElementById('bg-color').value = nodeData.style.bg;
                document.getElementById('text-color').value = nodeData.style.color;
                const fontSize = parseInt(nodeData.style.size);
                document.getElementById('font-size').value = fontSize;
                document.getElementById('font-size-value').innerText = `${fontSize}px`;
            }
        }

        function updateSelectedNode(prop) {
            if (!selectedNodeId) return;
            const nodeEl = document.getElementById(selectedNodeId);
            const nodeData = nodes.find(n => n.id === selectedNodeId);

            if (prop === 'bg') {
                const val = document.getElementById('bg-color').value;
                nodeEl.style.backgroundColor = val;
                nodeData.style.bg = val;
            } else if (prop === 'color') {
                const val = document.getElementById('text-color').value;
                nodeEl.style.color = val;
                nodeData.style.color = val;
            } else if (prop === 'size') {
                const val = document.getElementById('font-size').value;
                nodeEl.style.fontSize = val + 'px';
                nodeData.style.size = val + 'px';
                document.getElementById('font-size-value').innerText = `${val}px`;
            }
        }

        function deleteSelected() {
            if (!selectedNodeId) return;
            
            // Borrar conexiones asociadas
            connections = connections.filter(c => c.from !== selectedNodeId && c.to !== selectedNodeId);
            
            // Borrar nodo del DOM y Array
            const nodeEl = document.getElementById(selectedNodeId);
            if(nodeEl) nodeEl.remove();

            nodes = nodes.filter(n => n.id !== selectedNodeId);
            
            selectedNodeId = null;
            renderConnections();
        }

        // --- SISTEMA DE VINCULACI칍N ---

        function toggleLinkMode() {
            isLinkMode = !isLinkMode;
            linkSourceId = null;
            const btn = document.getElementById('btn-link');
            const indicator = document.getElementById('mode-indicator');
            
            // Limpiar cualquier borde azul temporal de un intento de vinculaci칩n anterior
            document.querySelectorAll('.node').forEach(n => n.style.borderColor = '#aaa');

            if (isLinkMode) {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                indicator.style.display = 'block';
                indicator.innerText = "Selecciona el nodo ORIGEN";
            } else {
                btn.classList.add('btn-secondary');
                btn.classList.remove('btn-primary');
                indicator.style.display = 'none';
            }
        }

        function handleLinkClick(id) {
            const indicator = document.getElementById('mode-indicator');
            const clickedNode = document.getElementById(id);
            
            if (!linkSourceId) {
                // Primer clic: Origen
                linkSourceId = id;
                indicator.innerText = "Ahora selecciona el nodo DESTINO";
                clickedNode.style.borderColor = "blue";
            } else {
                // Segundo clic: Destino
                if (linkSourceId !== id) {
                    // Verificar si la conexi칩n ya existe para evitar duplicados
                    const exists = connections.some(c => 
                        (c.from === linkSourceId && c.to === id) || 
                        (c.from === id && c.to === linkSourceId)
                    );
                    
                    if (!exists) {
                        connections.push({ from: linkSourceId, to: id });
                        renderConnections();
                    }
                }
                
                // Resetear estado y salir del modo vincular
                document.getElementById(linkSourceId).style.borderColor = "#aaa";
                toggleLinkMode(); 
            }
        }

        // --- RENDERIZADO DE L칈NEAS SVG ---

        function renderConnections() {
            svgLayer.innerHTML = ''; // Limpiar SVG
            
            connections.forEach(conn => {
                const fromNode = document.getElementById(conn.from);
                const toNode = document.getElementById(conn.to);
                
                if (!fromNode || !toNode) return;

                // Obtener posiciones exactas del DOM
                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                const wsRect = workspace.getBoundingClientRect(); // Para calcular offsets del workspace

                // Calcular el centro de cada nodo, ajustado a la posici칩n de la ventana (scroll es 0,0)
                const fromX = fromRect.left + fromRect.width / 2 - wsRect.left;
                const fromY = fromRect.top + fromRect.height / 2 - wsRect.top;
                const toX = toRect.left + toRect.width / 2 - wsRect.left;
                const toY = toRect.top + toRect.height / 2 - wsRect.top;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', fromX);
                line.setAttribute('y1', fromY);
                line.setAttribute('x2', toX);
                line.setAttribute('y2', toY);
                line.setAttribute('stroke', '#555');
                line.setAttribute('stroke-width', '2');
                
                svgLayer.appendChild(line);
            });
        }

        // --- DRAG AND DROP (ARRASTRE) L칍GICA CORREGIDA ---
        
        let activeDrag = null;
        let initialX, initialY, initialLeft, initialTop;

        function startDragLogic(e, node) {
            activeDrag = node;
            initialX = e.clientX;
            initialY = e.clientY;
            initialLeft = node.offsetLeft;
            initialTop = node.offsetTop;
            
            document.onmousemove = drag;
            document.onmouseup = endDrag;
        }

        function drag(e) {
            if (!activeDrag) return;
            e.preventDefault();
            
            const dx = e.clientX - initialX;
            const dy = e.clientY - initialY;
            
            activeDrag.style.left = (initialLeft + dx) + 'px';
            activeDrag.style.top = (initialTop + dy) + 'px';
            
            renderConnections(); // Actualizar l칤neas en tiempo real
        }

        function endDrag() {
            if (activeDrag) {
                // Actualizar datos del array l칩gico
                const nodeData = nodes.find(n => n.id === activeDrag.id);
                if(nodeData) {
                    nodeData.x = activeDrag.offsetLeft;
                    nodeData.y = activeDrag.offsetTop;
                }
                activeDrag.style.cursor = 'grab'; // Restaurar cursor
            }
            activeDrag = null;
            document.onmousemove = null;
            document.onmouseup = null;
        }

        // --- EXPORTACI칍N ---

        function updateNodeDataForExport() {
            // Sincroniza el contenido y las dimensiones del DOM con el array 'nodes'
            nodes.forEach(n => {
                const el = document.getElementById(n.id);
                if(el) {
                    n.text = el.querySelector('.node-content').innerText;
                    n.width = el.style.width;
                    n.height = el.style.height;
                }
            });
        }

        function exportPNG() {
            // Deseleccionar todo para que no salga el borde azul
            document.querySelectorAll('.selected').forEach(n => n.classList.remove('selected'));
            
            // html2canvas captura el workspace
            html2canvas(document.querySelector("#workspace")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'mapa_conceptual.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportHTML() {
            updateNodeDataForExport(); // Sincroniza datos antes de guardar
            
            const data = {
                nodes: nodes,
                connections: connections
            };
            
            const json = JSON.stringify(data);
            
            // Creamos una copia del HTML actual y le inyectamos los datos para que sea editable al reabrirlo.
            const fullHTML = document.documentElement.outerHTML;
            
            // Expresi칩n regular para encontrar el placeholder y reemplazarlo con el script de carga
            const scriptInjection = `window.loadData = ${json};`;
            const newHTML = fullHTML.replace('/*DATA_PLACEHOLDER*/', scriptInjection);

            const blob = new Blob([newHTML], {type: "text/html"});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "mi_mapa.html";
            link.click();
        }

        // --- INICIALIZACI칍N Y RECUPERACI칍N ---
        
        // Carga autom치tica si el archivo se guard칩 a s칤 mismo
        window.onload = function() {
            // Ajustar tama침o del canvas SVG al redimensionar ventana
            window.onresize = renderConnections;

            if (window.loadData) {
                // Cargar nodos guardados
                nodes = []; 
                window.loadData.nodes.forEach(n => createNode(n));
                connections = window.loadData.connections;
                
                // Esperar un momento para que el DOM se renderice antes de dibujar las l칤neas
                setTimeout(renderConnections, 50); 
            } else {
                // Nodo inicial si es la primera vez
                createNode();
            }

            // Deseleccionar si se hace clic fuera de cualquier nodo
            workspace.onclick = (e) => {
                // Solo deselecciona si no se est치 en modo vincular y no se hizo clic en un nodo
                if (e.target.id === 'workspace' && !isLinkMode) {
                    document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
                    selectedNodeId = null;
                }
            };
        };

        /*DATA_PLACEHOLDER*/ // Aqu칤 se inyectar치n los datos al exportar HTML
    </script>
</body>
</html>
