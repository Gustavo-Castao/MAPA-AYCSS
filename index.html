<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo Arte y Ciencias Sociales</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 13px;
            color: #e6e6e6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #16213e;
            border-radius: 6.5px;
            padding: 13px;
            box-shadow: 0 1.3px 6.5px rgba(0,0,0,0.3);
            display: flex;
            gap: 13px;
        }

        h1 {
            text-align: center;
            color: #e6e6e6;
            margin-bottom: 13px;
            font-size: 1.6em;
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sidebar {
            width: 180px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            background: #0f3460;
            color: #e6e6e6;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 1.3px 5.2px rgba(0,0,0,0.3);
            background: #1a5089;
        }

        .btn-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e94560;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-primary { background: #0f3460; }
        .btn-success { background: #1b512d; }
        .btn-warning { background: #8a5a15; }
        .btn-info { background: #1a5089; }
        .btn-export { background: #4a235a; }
        .btn-preview { background: #14532d; }
        .btn-danger { background: #7c1a1a; }

        .workspace-container {
            position: relative;
            flex: 1;
            height: 800px;
            overflow: hidden;
            border: 1.3px solid #2d3748;
            border-radius: 5.2px;
            margin-bottom: 13px;
            background: #1a1a2e;
            transition: background-color 0.3s ease;
        }

        .workspace {
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            transition: transform 0.3s ease;
        }

        .node {
            position: absolute;
            min-width: 73px;
            max-width: 100px;
            padding: 5.5px;
            background: #1e293b;
            border-radius: 5.2px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 1.3px 5.2px rgba(0,0,0,0.3);
            border: 1.3px solid #4a5568;
            user-select: none;
            transition: all 0.2s ease;
            z-index: 10;
            font-size: 0.65em;
            color: #e6e6e6;
        }

        .node:hover {
            transform: scale(1.03);
            box-shadow: 0 2.6px 7.8px rgba(0,0,0,0.4);
        }

        .node.dragging {
            transform: scale(1.05);
            box-shadow: 0 3.9px 13px rgba(0,0,0,0.5);
            z-index: 1000;
            cursor: grabbing;
        }

        .node-main {
            border-color: #4299e1;
            background: #2a4365;
        }

        .node-title {
            font-family: 'EB Garamond', 'Garamond', 'Times New Roman', serif;
            font-weight: 600;
            font-size: 9.1px;
            margin-bottom: 1.3px;
            line-height: 1.2;
        }

        .node-subtitle {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 500;
            font-size: 8.45px;
            margin-bottom: 5.2px;
            font-style: italic;
            line-height: 1.2;
            opacity: 0.8;
        }

        .connection {
            position: absolute;
            background: #718096;
            height: 1.95px;
            transform-origin: 0 0;
            pointer-events: none;
            z-index: 5;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 5.2px solid transparent;
            border-right: 5.2px solid transparent;
            border-top: 7.8px solid #718096;
            transform-origin: center;
            pointer-events: none;
            z-index: 6;
        }

        .connection-mode {
            background: #744210;
            color: #fef3c7;
            padding: 5.2px;
            border-radius: 2.6px;
            text-align: center;
            margin-bottom: 5.2px;
            display: none;
            font-weight: bold;
            font-size: 8.45px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #1a1a2e;
            margin: 3.25% auto;
            padding: 19.5px;
            border-radius: 6.5px;
            width: 90%;
            max-width: 455px;
            box-shadow: 0 3.25px 16.25px rgba(0,0,0,0.5);
            position: relative;
            max-height: 55.25vh;
            overflow-y: auto;
            animation: zoomIn 0.3s ease;
            transform-origin: center center;
            border: 1px solid #2d3748;
            color: #e6e6e6;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .close-modal {
            position: absolute;
            right: 10.4px;
            top: 10.4px;
            font-size: 15.6px;
            font-weight: bold;
            cursor: pointer;
            color: #a0aec0;
            background: none;
            border: none;
            padding: 0;
            width: 19.5px;
            height: 19.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #e6e6e6;
        }

        .modal-title {
            font-family: 'EB Garamond', serif;
            font-size: 18.2px;
            margin-bottom: 6.5px;
            color: #e6e6e6;
        }

        .modal-subtitle {
            font-family: 'EB Garamond', serif;
            font-size: 9.1px;
            margin-bottom: 10.4px;
            color: #a0aec0;
            font-style: italic;
        }

        .modal-author {
            font-family: 'Calibri', sans-serif;
            font-size: 7.8px;
            margin-bottom: 13px;
            color: #a0aec0;
            font-style: italic;
        }

        .modal-image {
            max-width: 100%;
            max-height: 195px;
            margin: 10.4px 0;
            border-radius: 5.2px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-description {
            font-family: 'Calibri', sans-serif;
            font-size: 10.4px;
            line-height: 1.6;
            color: #e6e6e6;
            padding: 13px;
            background: #2d3748;
            border-radius: 3.25px;
        }

        .form-group {
            margin-bottom: 7.8px;
        }

        label {
            display: block;
            margin-bottom: 2.6px;
            font-weight: bold;
            color: #e6e6e6;
            font-size: 8.45px;
        }

        input, select, textarea {
            width: 100%;
            padding: 5.2px;
            border: 0.65px solid #4a5568;
            border-radius: 2.6px;
            font-size: 8.45px;
            background: #2d3748;
            color: #e6e6e6;
        }

        .image-preview {
            max-width: 100%;
            max-height: 97.5px;
            margin-top: 6.5px;
            border-radius: 2.6px;
            display: none;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #1a1a2e;
            border-radius: 5px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 20;
            border: 1px solid #2d3748;
        }

        .zoom-controls button {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 2px;
            background: #0f3460;
            color: #e6e6e6;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .zoom-controls button:hover {
            background: #1a5089;
        }

        .info-panel {
            background: #2d3748;
            padding: 10.4px;
            border-radius: 5.2px;
            margin-bottom: 10.4px;
            font-size: 0.65em;
        }

        .info-panel h3 {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 600;
            color: #e6e6e6;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .preview-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-print {
            background: #1a5089;
            color: white;
        }

        .btn-save {
            background: #1b512d;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .workspace-container {
                height: 500px;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
            
            .node {
                min-width: 64px;
                padding: 4.5px;
            }
            
            .node-title {
                font-size: 8.2px;
            }
            
            .modal-content {
                margin: 1.3% auto;
                width: 95%;
                padding: 13px;
            }
            
            h1 {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <button class="btn btn-primary" onclick="showNodeModal()">
                <div class="btn-icon">N</div>
                Nodo
            </button>
            <button class="btn btn-info" onclick="startConnection()">
                <div class="btn-icon">C</div>
                Conectar
            </button>
            <button class="btn btn-preview" onclick="openPreviewModal()">
                <div class="btn-icon">V</div>
                Vista Previa
            </button>
            <button class="btn btn-export" onclick="showExportModal()">
                <div class="btn-icon">E</div>
                Exportar HTML
            </button>
            <button class="btn btn-warning" onclick="editSelectedNode()">
                <div class="btn-icon">E</div>
                Editar T√≠tulo
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedNode()">
                <div class="btn-icon">B</div>
                Borrar Nodo
            </button>
            <button class="btn btn-danger" onclick="clearAll()">
                <div class="btn-icon">L</div>
                Limpiar Todo
            </button>
        </div>

        <div class="main-content">
            <h1>MAPA INTERACTIVO ARTE Y CIENCIAS SOCIALES</h1>
            
            <div class="connection-mode" id="connectionMode">
                üîó Modo Conexi√≥n: Selecciona el nodo destino
            </div>

            <div class="workspace-container" id="workspaceContainer">
                <div class="workspace" id="workspace">
                    <!-- Los nodos y conexiones se crear√°n aqu√≠ -->
                </div>
                <div class="zoom-controls">
                    <button onclick="zoomIn()">+</button>
                    <button onclick="zoomOut()">-</button>
                    <button onclick="resetZoom()">‚ü≥</button>
                </div>
            </div>

            <div class="info-panel">
                <h3>üí° Informaci√≥n del Mapa</h3>
                <div id="nodeInfo">
                    <p>Haz doble click en cualquier nodo para ver sus opciones</p>
                    <p>Total de nodos: <span id="nodesCount">0</span> | Conexiones: <span id="connectionsCount">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar nodo -->
    <div id="nodeModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeNodeModal()">&times;</button>
            <h3 class="modal-title" id="nodeModalTitle">Crear Nuevo Nodo</h3>
            <div class="form-group">
                <label for="nodeTitle">T√≠tulo:</label>
                <input type="text" id="nodeTitle" placeholder="Ej: Inteligencia Artificial">
            </div>
            <div class="form-group">
                <label for="nodeSubtitle">Subt√≠tulo:</label>
                <input type="text" id="nodeSubtitle" placeholder="Ej: Definici√≥n y conceptos b√°sicos">
            </div>
            <div class="form-group">
                <label for="nodeAuthor">Texto o Autor:</label>
                <input type="text" id="nodeAuthor" placeholder="Ej: Roger Charnier (1990)">
            </div>
            <div class="form-group">
                <label for="nodeDescription">Descripci√≥n:</label>
                <textarea id="nodeDescription" placeholder="Ej: La inteligencia artificial es el campo de la inform√°tica que se centra en la creaci√≥n de sistemas que pueden realizar tareas que normalmente requieren inteligencia humana..." rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="nodeImage">Imagen (opcional):</label>
                <input type="file" id="nodeImage" accept="image/*" onchange="previewImage(this)">
                <img id="imagePreview" class="image-preview" alt="Vista previa de imagen">
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveNode()" style="flex: 1;">Guardar Nodo</button>
                <button class="btn btn-danger" onclick="closeNodeModal()" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para descripci√≥n -->
    <div id="descriptionModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <h3 class="modal-subtitle" id="modalSubtitle"></h3>
            <div class="modal-author" id="modalAuthor"></div>
            <img id="modalImage" class="modal-image" style="display: none;" alt="Imagen del nodo">
            <div class="modal-description" id="modalDescription"></div>
        </div>
    </div>

    <!-- Modal para exportar -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeExportModal()">&times;</button>
            <h3 class="modal-title">Exportar Mapa</h3>
            <p>Guarda este c√≥digo HTML para alojarlo en cualquier servidor:</p>
            <textarea id="exportCode" rows="6" style="width: 100%; font-family: monospace; font-size: 7.8px; padding: 6.5px; border: 0.65px solid #4a5568; border-radius: 2.6px; background: #2d3748; color: #e6e6e6;"></textarea>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="copyToClipboard()" style="flex: 1;">Copiar C√≥digo</button>
                <button class="btn btn-primary" onclick="downloadHTML()" style="flex: 1;">Descargar HTML</button>
                <button class="btn btn-danger" onclick="closeExportModal()" style="flex: 1;">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para vista previa -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closePreviewModal()">&times;</button>
            <h3 class="modal-title">Vista Previa del Mapa</h3>
            <div id="previewContent" style="border: 1px solid #4a5568; border-radius: 5px; padding: 10px; background: #1a1a2e; min-height: 300px; overflow: auto;">
                <!-- Contenido de la vista previa -->
            </div>
            <div class="preview-actions">
                <button class="btn-save" onclick="savePreview()">Guardar</button>
                <button class="btn-print" onclick="printPreview()">Imprimir</button>
                <button class="btn btn-danger" onclick="closePreviewModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let nodes = [];
        let connections = [];
        let connectionMode = false;
        let sourceNodeId = null;
        let nodeCounter = 0;
        let currentImage = null;
        let editingNodeId = null;
        let selectedNodeId = null;
        let zoomLevel = 1;
        let translateX = 0, translateY = 0;

        // Elementos DOM
        const workspace = document.getElementById('workspace');
        const workspaceContainer = document.getElementById('workspaceContainer');
        const connectionModeDiv = document.getElementById('connectionMode');
        const nodeInfo = document.getElementById('nodeInfo');

        // Modal functions
        function showNodeModal() {
            document.getElementById('nodeModal').style.display = 'block';
            document.getElementById('nodeModalTitle').textContent = 'Crear Nuevo Nodo';
            clearNodeForm();
            editingNodeId = null;
        }

        function closeNodeModal() {
            document.getElementById('nodeModal').style.display = 'none';
            editingNodeId = null;
        }

        function showExportModal() {
            generateExportCode();
            document.getElementById('exportModal').style.display = 'block';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function openPreviewModal() {
            document.getElementById('previewModal').style.display = 'block';
            updatePreviewContent();
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('descriptionModal').style.display = 'none';
        }

        // Vista previa de imagen
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    currentImage = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                currentImage = null;
            }
        }

        // Limpiar formulario
        function clearNodeForm() {
            document.getElementById('nodeTitle').value = '';
            document.getElementById('nodeSubtitle').value = '';
            document.getElementById('nodeAuthor').value = '';
            document.getElementById('nodeDescription').value = '';
            document.getElementById('nodeImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            currentImage = null;
        }

        // Guardar nodo (crear o editar)
        function saveNode() {
            const title = document.getElementById('nodeTitle').value.trim();
            const subtitle = document.getElementById('nodeSubtitle').value.trim();
            const author = document.getElementById('nodeAuthor').value.trim();
            const description = document.getElementById('nodeDescription').value.trim();

            if (!title) {
                alert('Por favor ingresa un t√≠tulo');
                return;
            }

            if (editingNodeId) {
                // Editar nodo existente
                const node = nodes.find(n => n.id === editingNodeId);
                if (node) {
                    node.title = title;
                    node.subtitle = subtitle;
                    node.author = author;
                    node.description = description;
                    node.image = currentImage;
                    
                    // Re-renderizar el nodo
                    renderAll();
                }
            } else {
                // Crear nuevo nodo
                nodeCounter++;
                const nodeId = 'node-' + nodeCounter;

                // Posici√≥n aleatoria en el workspace
                const x = Math.random() * (workspace.offsetWidth - 80) + 20;
                const y = Math.random() * (workspace.offsetHeight - 45) + 15;

                const node = {
                    id: nodeId,
                    title: title,
                    subtitle: subtitle,
                    author: author,
                    description: description,
                    image: currentImage,
                    type: 'main',
                    x: x,
                    y: y
                };

                nodes.push(node);
                renderNode(node);
                updateCounters();
            }

            closeNodeModal();
        }

        // Editar nodo seleccionado
        function editSelectedNode() {
            if (!selectedNodeId) {
                alert('Por favor selecciona un nodo primero haciendo clic en √©l');
                return;
            }
            
            const node = nodes.find(n => n.id === selectedNodeId);
            if (!node) return;

            editingNodeId = node.id;
            document.getElementById('nodeModalTitle').textContent = 'Editar Nodo';
            
            // Llenar formulario con datos existentes
            document.getElementById('nodeTitle').value = node.title;
            document.getElementById('nodeSubtitle').value = node.subtitle || '';
            document.getElementById('nodeAuthor').value = node.author || '';
            document.getElementById('nodeDescription').value = node.description || '';
            
            // Manejar imagen
            const preview = document.getElementById('imagePreview');
            if (node.image) {
                preview.src = node.image;
                preview.style.display = 'block';
                currentImage = node.image;
            } else {
                preview.style.display = 'none';
                currentImage = null;
            }
            
            document.getElementById('nodeModal').style.display = 'block';
        }

        // Eliminar nodo seleccionado
        function deleteSelectedNode() {
            if (!selectedNodeId) {
                alert('Por favor selecciona un nodo primero haciendo clic en √©l');
                return;
            }

            if (!confirm('¬øEst√°s seguro de que quieres eliminar este nodo?')) return;

            // Eliminar conexiones relacionadas
            connections = connections.filter(conn => 
                conn.from !== selectedNodeId && conn.to !== selectedNodeId
            );

            // Eliminar nodo
            nodes = nodes.filter(n => n.id !== selectedNodeId);
            selectedNodeId = null;
            
            // Re-renderizar
            renderAll();
            updateCounters();
        }

        // Mostrar modal de descripci√≥n
        function showDescriptionModal(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            document.getElementById('modalTitle').textContent = node.title;
            document.getElementById('modalSubtitle').textContent = node.subtitle || 'Sin subt√≠tulo';
            document.getElementById('modalAuthor').textContent = node.author ? `Autor: ${node.author}` : 'Autor no especificado';
            document.getElementById('modalDescription').textContent = node.description || 'Sin descripci√≥n disponible.';
            
            const modalImage = document.getElementById('modalImage');
            if (node.image) {
                modalImage.src = node.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            document.getElementById('descriptionModal').style.display = 'block';
        }

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', function(event) {
            const modals = ['nodeModal', 'descriptionModal', 'exportModal', 'previewModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'nodeModal') closeNodeModal();
                    else if (modalId === 'descriptionModal') closeModal();
                    else if (modalId === 'exportModal') closeExportModal();
                    else if (modalId === 'previewModal') closePreviewModal();
                }
            });
        });

        // Renderizar nodo en el workspace
        function renderNode(node) {
            const nodeElement = document.createElement('div');
            nodeElement.className = `node node-main`;
            nodeElement.id = node.id;
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            
            nodeElement.innerHTML = `
                <div class="node-title">${node.title}</div>
                ${node.subtitle ? `<div class="node-subtitle">${node.subtitle}</div>` : ''}
            `;

            // Hacer arrastrable
            makeDraggable(nodeElement, node);

            // Evento click simple para selecci√≥n
            nodeElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                // Deseleccionar nodo anterior
                if (selectedNodeId) {
                    const prevNode = document.getElementById(selectedNodeId);
                    if (prevNode) prevNode.style.boxShadow = '0 1.3px 5.2px rgba(0,0,0,0.3)';
                }
                
                // Seleccionar nuevo nodo
                selectedNodeId = node.id;
                nodeElement.style.boxShadow = '0 0 0 2px #e94560';
                
                if (connectionMode && sourceNodeId && sourceNodeId !== node.id) {
                    createConnection(sourceNodeId, node.id);
                    setConnectionMode(false);
                } else if (connectionMode && !sourceNodeId) {
                    sourceNodeId = node.id;
                    connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el nodo destino';
                }
            });

            // Evento doble click para mostrar descripci√≥n
            nodeElement.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                if (!connectionMode) {
                    showDescriptionModal(node.id);
                }
            });

            workspace.appendChild(nodeElement);
        }

        // Hacer nodo arrastrable
        function makeDraggable(element, node) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', startDrag);

            function startDrag(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                e.preventDefault();
                isDragging = true;
                element.classList.add('dragging');
                
                startX = e.clientX;
                startY = e.clientY;
                initialX = element.offsetLeft;
                initialY = element.offsetTop;
                
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
            }

            function onDrag(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newX = initialX + dx;
                let newY = initialY + dy;

                // Mantener dentro de los l√≠mites
                newX = Math.max(6.5, Math.min(newX, workspace.offsetWidth - element.offsetWidth - 6.5));
                newY = Math.max(6.5, Math.min(newY, workspace.offsetHeight - element.offsetHeight - 6.5));

                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
                
                node.x = newX;
                node.y = newY;

                updateConnections();
            }

            function stopDrag() {
                isDragging = false;
                element.classList.remove('dragging');
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
            }
        }

        // Iniciar modo conexi√≥n
        function startConnection() {
            if (nodes.length < 2) {
                alert('Necesitas al menos 2 nodos para crear conexiones');
                return;
            }
            setConnectionMode(true);
            sourceNodeId = null;
            nodeInfo.innerHTML = '<p>üîó Selecciona el primer nodo para conectar</p>';
        }

        // Activar/desactivar modo conexi√≥n
        function setConnectionMode(active) {
            connectionMode = active;
            if (active) {
                connectionModeDiv.style.display = 'block';
                connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el primer nodo';
            } else {
                connectionModeDiv.style.display = 'none';
                sourceNodeId = null;
            }
        }

        // Crear conexi√≥n entre nodos
        function createConnection(fromId, toId) {
            // Evitar conexiones duplicadas
            const existingConnection = connections.find(conn => 
                (conn.from === fromId && conn.to === toId) || 
                (conn.from === toId && conn.to === fromId)
            );

            if (existingConnection) {
                alert('Estos nodos ya est√°n conectados');
                return;
            }

            if (fromId === toId) {
                alert('No puedes conectar un nodo consigo mismo');
                return;
            }

            connections.push({ from: fromId, to: toId });
            renderConnection(fromId, toId);
            updateCounters();
        }

        // Renderizar conexi√≥n
        function renderConnection(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const toNode = nodes.find(n => n.id === toId);

            if (!fromNode || !toNode) return;

            // Crear l√≠nea
            const line = document.createElement('div');
            line.className = 'connection';
            line.id = 'conn-' + fromId + '-' + toId;

            // Crear flecha
            const arrow = document.createElement('div');
            arrow.className = 'connection-arrow';
            arrow.id = 'arrow-' + fromId + '-' + toId;

            workspace.appendChild(line);
            workspace.appendChild(arrow);

            updateConnection(fromId, toId);
        }

        // Actualizar posici√≥n de conexi√≥n
        function updateConnection(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const toNode = nodes.find(n => n.id === toId);
            const line = document.getElementById('conn-' + fromId + '-' + toId);
            const arrow = document.getElementById('arrow-' + fromId + '-' + toId);

            if (!fromNode || !toNode || !line || !arrow) return;

            const fromElement = document.getElementById(fromId);
            const toElement = document.getElementById(toId);

            if (!fromElement || !toElement) return;

            const fromX = fromNode.x + fromElement.offsetWidth / 2;
            const fromY = fromNode.y + fromElement.offsetHeight / 2;
            const toX = toNode.x + toElement.offsetWidth / 2;
            const toY = toNode.y + toElement.offsetHeight / 2;

            const dx = toX - fromX;
            const dy = toY - fromY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            line.style.width = length + 'px';
            line.style.left = fromX + 'px';
            line.style.top = fromY + 'px';
            line.style.transform = 'rotate(' + angle + 'deg)';

            arrow.style.left = toX + 'px';
            arrow.style.top = toY + 'px';
            arrow.style.transform = 'rotate(' + angle + 'deg)';
        }

        // Actualizar todas las conexiones
        function updateConnections() {
            connections.forEach(conn => {
                updateConnection(conn.from, conn.to);
            });
        }

        // Actualizar contadores
        function updateCounters() {
            document.getElementById('nodesCount').textContent = nodes.length;
            document.getElementById('connectionsCount').textContent = connections.length;
        }

        // Limpiar todo
        function clearAll() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar todo?')) return;
            
            nodes = [];
            connections = [];
            selectedNodeId = null;
            renderAll();
            updateCounters();
        }

        // Renderizar todo
        function renderAll() {
            workspace.innerHTML = '';
            nodes.forEach(node => renderNode(node));
            connections.forEach(conn => renderConnection(conn.from, conn.to));
            updateWorkspaceTransform();
        }

        // Generar c√≥digo para exportar
        function generateExportCode() {
            const exportHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo Arte y Ciencias Sociales</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Calibri', sans-serif; background: #1a1a2e; min-height: 100vh; padding: 10px; color: #e6e6e6; }
        .container { max-width: 1400px; margin: 0 auto; background: #16213e; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #e6e6e6; margin-bottom: 15px; font-size: 1.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .workspace-container { position: relative; width: 100%; height: 800px; overflow: auto; border: 1px solid #2d3748; border-radius: 8px; margin-bottom: 15px; background: #1a1a2e; }
        .workspace { position: relative; width: 100%; height: 100%; min-width: 800px; min-height: 600px; }
        .node { position: absolute; min-width: 80px; max-width: 120px; padding: 8px; background: #2a4365; border-radius: 6px; cursor: pointer; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 1px solid #4299e1; user-select: none; transition: all 0.2s ease; z-index: 10; font-size: 12px; color: #e6e6e6; }
        .node:hover { transform: scale(1.03); box-shadow: 0 3px 12px rgba(0,0,0,0.4); }
        .node-title { font-family: 'EB Garamond', serif; font-weight: 600; font-size: 14px; margin-bottom: 2px; line-height: 1.2; word-wrap: break-word; }
        .node-subtitle { font-family: 'Calibri', sans-serif; font-weight: 500; font-size: 11px; margin-bottom: 6px; font-style: italic; line-height: 1.2; opacity: 0.8; word-wrap: break-word; }
        .connection { position: absolute; background: #718096; height: 2px; transform-origin: 0 0; pointer-events: none; z-index: 5; }
        .connection-arrow { position: absolute; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid #718096; transform-origin: center; pointer-events: none; z-index: 6; }
        .info-panel { background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .info-panel h3 { font-family: 'Calibri', sans-serif; font-weight: 600; margin-bottom: 10px; color: #e6e6e6; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #1a1a2e; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); position: relative; max-height: 80vh; overflow-y: auto; border: 1px solid #2d3748; color: #e6e6e6; }
        .close-modal { position: absolute; right: 15px; top: 15px; font-size: 20px; font-weight: bold; cursor: pointer; color: #a0aec0; background: none; border: none; padding: 0; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; }
        .close-modal:hover { color: #e6e6e6; }
        .modal-title { font-family: 'EB Garamond', serif; font-size: 22px; margin-bottom: 8px; color: #e6e6e6; }
        .modal-subtitle { font-family: 'EB Garamond', serif; font-size: 14px; margin-bottom: 15px; color: #a0aec0; font-style: italic; }
        .modal-author { font-family: 'Calibri', sans-serif; font-size: 13px; margin-bottom: 15px; color: #a0aec0; font-style: italic; }
        .modal-image { max-width: 100%; max-height: 200px; margin: 15px 0; border-radius: 6px; display: block; margin-left: auto; margin-right: auto; }
        .modal-description { font-family: 'Calibri', sans-serif; font-size: 14px; line-height: 1.6; color: #e6e6e6; padding: 15px; background: #2d3748; border-radius: 6px; }
        @media (max-width: 768px) { .workspace-container { height: 500px; } .node { min-width: 70px; max-width: 100px; padding: 6px; font-size: 11px; } .node-title { font-size: 12px; } .node-subtitle { font-size: 10px; } .modal-content { margin: 10% auto; padding: 20px; width: 95%; } h1 { font-size: 1.4em; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>MAPA INTERACTIVO ARTE Y CIENCIAS SOCIALES</h1>
        <div class="workspace-container">
            <div class="workspace" id="workspace"></div>
        </div>
        <div class="info-panel">
            <h3>INFORMACI√ìN DEL MAPA</h3>
            <p>Total de nodos: ${nodes.length} | Conexiones: ${connections.length}</p>
            <p>Haz click en cualquier nodo para ver m√°s informaci√≥n</p>
        </div>
    </div>

    <div id="descriptionModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <h3 class="modal-subtitle" id="modalSubtitle"></h3>
            <div class="modal-author" id="modalAuthor"></div>
            <img id="modalImage" class="modal-image" style="display: none;" alt="Imagen del nodo">
            <div class="modal-description" id="modalDescription"></div>
        </div>
    </div>

    <script>
        const nodes = ${JSON.stringify(nodes)};
        const connections = ${JSON.stringify(connections)};
        
        function loadMap() {
            const workspace = document.getElementById('workspace');
            
            // Cargar nodos
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node';
                nodeElement.style.left = node.x + 'px';
                nodeElement.style.top = node.y + 'px';
                nodeElement.innerHTML = 
                    '<div class="node-title">' + node.title + '</div>' + 
                    (node.subtitle ? '<div class="node-subtitle">' + node.subtitle + '</div>' : '');
                
                nodeElement.addEventListener('click', function() {
                    showDescriptionModal(node.id);
                });
                
                workspace.appendChild(nodeElement);
            });

            // Cargar conexiones
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const fromX = fromNode.x + 40;
                    const fromY = fromNode.y + 20;
                    const toX = toNode.x + 40;
                    const toY = toNode.y + 20;
                    
                    const dx = toX - fromX;
                    const dy = toY - fromY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    const line = document.createElement('div');
                    line.className = 'connection';
                    line.style.width = length + 'px';
                    line.style.left = fromX + 'px';
                    line.style.top = fromY + 'px';
                    line.style.transform = 'rotate(' + angle + 'deg)';
                    
                    const arrow = document.createElement('div');
                    arrow.className = 'connection-arrow';
                    arrow.style.left = toX + 'px';
                    arrow.style.top = toY + 'px';
                    arrow.style.transform = 'rotate(' + angle + 'deg)';
                    
                    workspace.appendChild(line);
                    workspace.appendChild(arrow);
                }
            });
        }

        function showDescriptionModal(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            document.getElementById('modalTitle').textContent = node.title;
            document.getElementById('modalSubtitle').textContent = node.subtitle || 'Sin subt√≠tulo';
            document.getElementById('modalAuthor').textContent = node.author ? 'Autor: ' + node.author : 'Autor no especificado';
            document.getElementById('modalDescription').textContent = node.description || 'Sin descripci√≥n disponible.';
            
            const modalImage = document.getElementById('modalImage');
            if (node.image) {
                modalImage.src = node.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            document.getElementById('descriptionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('descriptionModal').style.display = 'none';
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('descriptionModal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', loadMap);
    <\/script>
</body>
</html>`;

            document.getElementById('exportCode').value = exportHTML;
        }

        // Copiar al portapapeles
        function copyToClipboard() {
            const exportCode = document.getElementById('exportCode');
            exportCode.select();
            navigator.clipboard.writeText(exportCode.value).then(() => {
                alert('‚úÖ C√≥digo copiado al portapapeles');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ C√≥digo copiado al portapapeles');
            });
        }

        // Descargar como HTML
        function downloadHTML() {
            const exportCode = document.getElementById('exportCode').value;
            const blob = new Blob([exportCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mapa-interactivo.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úÖ Archivo HTML descargado correctamente');
        }

        // Actualizar contenido de vista previa
        function updatePreviewContent() {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = '';
            
            // Crear una representaci√≥n simplificada del mapa
            const previewWorkspace = document.createElement('div');
            previewWorkspace.style.position = 'relative';
            previewWorkspace.style.width = '100%';
            previewWorkspace.style.height = '400px';
            previewWorkspace.style.overflow = 'auto';
            previewWorkspace.style.border = '1px solid #4a5568';
            previewWorkspace.style.borderRadius = '5px';
            previewWorkspace.style.padding = '10px';
            previewWorkspace.style.background = '#1a1a2e';
            
            // Agregar nodos a la vista previa
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node';
                nodeElement.style.position = 'absolute';
                nodeElement.style.left = (node.x / 2) + 'px';
                nodeElement.style.top = (node.y / 2) + 'px';
                nodeElement.style.minWidth = '60px';
                nodeElement.style.maxWidth = '80px';
                nodeElement.style.padding = '5px';
                nodeElement.style.background = '#2a4365';
                nodeElement.style.borderRadius = '4px';
                nodeElement.style.border = '1px solid #4299e1';
                nodeElement.style.fontSize = '10px';
                nodeElement.style.color = '#e6e6e6';
                nodeElement.style.textAlign = 'center';
                
                nodeElement.innerHTML = `
                    <div style="font-weight: bold; font-family: 'EB Garamond', serif;">${node.title}</div>
                    ${node.subtitle ? `<div style="font-style: italic; font-size: 9px;">${node.subtitle}</div>` : ''}
                `;
                
                previewWorkspace.appendChild(nodeElement);
            });
            
            previewContent.appendChild(previewWorkspace);
            
            // Agregar informaci√≥n de resumen
            const summary = document.createElement('div');
            summary.style.marginTop = '15px';
            summary.style.padding = '10px';
            summary.style.background = '#2d3748';
            summary.style.borderRadius = '5px';
            summary.innerHTML = `
                <h4 style="margin-bottom: 8px; color: #e6e6e6;">Resumen del Mapa</h4>
                <p>Total de nodos: ${nodes.length}</p>
                <p>Conexiones: ${connections.length}</p>
                <p>Fecha de generaci√≥n: ${new Date().toLocaleString()}</p>
            `;
            
            previewContent.appendChild(summary);
        }

        // Guardar vista previa
        function savePreview() {
            const element = document.getElementById('previewContent');
            const opt = {
                margin: 10,
                filename: 'mapa-preview.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false, backgroundColor: '#1a1a2e' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save();
        }

        // Imprimir vista previa
        function printPreview() {
            const previewContent = document.getElementById('previewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Mapa Interactivo - Vista Previa</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
                        .node { border: 1px solid #4299e1; background: #f0f8ff; padding: 8px; margin: 5px; border-radius: 4px; display: inline-block; }
                        .summary { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <h1>Mapa Interactivo - Vista Previa</h1>
                    <div>${previewContent}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Funciones de zoom
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.1, 2);
            updateWorkspaceTransform();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
            updateWorkspaceTransform();
        }

        function resetZoom() {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateWorkspaceTransform();
        }

        function updateWorkspaceTransform() {
            workspace.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
        }

        // Inicializar
        renderAll();
        updateCounters();

        // Agregar algunos nodos de ejemplo al inicio
        setTimeout(() => {
            const node1 = {
                id: 'node-1',
                title: 'Arte y Ciencias Sociales',
                subtitle: 'Intersecciones disciplinares',
                author: 'Varios autores',
                description: 'Este mapa explora las conexiones entre el arte y las ciencias sociales, examinando c√≥mo se influyen mutuamente.',
                image: null,
                type: 'main',
                x: 100,
                y: 100
            };

            const node2 = {
                id: 'node-2',
                title: 'Antropolog√≠a Visual',
                subtitle: 'Estudio cultural de las im√°genes',
                author: 'Margaret Mead',
                description: 'La antropolog√≠a visual estudia c√≥mo las sociedades humanas producen, interpretan y utilizan las im√°genes visuales.',
                image: null,
                type: 'main',
                x: 300,
                y: 200
            };

            nodes.push(node1, node2);
            renderAll();
            updateCounters();
        }, 500);
    </script>
</body>
</html>
