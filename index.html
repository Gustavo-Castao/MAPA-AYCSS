<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Conceptual PRO - Multiarchivo</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI,Arial;background:#dcdcdc}

#topbar{
  height:40px;background:#1e1e1e;color:white;
  display:flex;align-items:center;padding:0 10px;gap:10px
}
#tabs{
  height:35px;background:#2c2c2c;display:flex;align-items:center;overflow-x:auto
}
.tab{
  background:#3a3a3a;color:white;padding:6px 14px;margin-right:2px;
  cursor:pointer;border-top:3px solid transparent
}
.tab.active{
  background:#1e1e1e;border-top-color:#0a84ff
}

#main{display:flex;height:calc(100vh - 75px)}

#sidebar{
  width:220px;background:#2b2b2b;color:white;padding:10px
  display:flex;flex-direction:column;gap:10px
}

button{
  width:100%;padding:8px;border:none;background:#444;color:white;
  cursor:pointer;border-radius:6px
}
button:hover{background:#666}

#workspace{
  flex:1;position:relative;background:#fafafa;overflow:hidden
}

.node{
  position:absolute;padding:10px;min-width:120px;
  background:white;border:2px solid #333;border-radius:10px;
  cursor:move;user-select:none;
  box-shadow:0 4px 10px rgba(0,0,0,.15)
}
.node.selected{
  border-color:#0a84ff;
  box-shadow:0 0 0 2px rgba(10,132,255,.3)
}

.connection{
  position:absolute;height:2px;background:#333;
  transform-origin:left center;pointer-events:none
}

.arrow{
  position:absolute;width:0;height:0;
  border-top:6px solid transparent;border-bottom:6px solid transparent;
  border-left:10px solid #333;pointer-events:none
}

.label{
  position:absolute;background:white;padding:2px 6px;font-size:12px;
  border:1px solid #ccc;border-radius:6px;pointer-events:none
}

.mode{
  position:fixed;top:80px;left:240px;background:black;color:white;
  padding:8px 14px;border-radius:6px;display:none
}
</style>
</head>
<body>

<div id="topbar">
  <b>üß† MAPA CONCEPTUAL PRO</b>
  <button onclick="newFile()">Nuevo</button>
  <button onclick="openFile()">Abrir HTML</button>
  <button onclick="saveFile()">Guardar HTML</button>
</div>

<div id="tabs"></div>

<div id="main">
  <div id="sidebar">
    <button onclick="addNode()">‚ûï Nodo</button>
    <button onclick="toggleConnect()">üîó Conectar</button>
    <button onclick="toggleDisconnect()">‚ùå Desconectar</button>
    <button onclick="deleteNode()">üóë Eliminar nodo</button>
  </div>

  <div id="workspace"></div>
</div>

<div id="modeBox" class="mode"></div>
<input type="file" id="fileInput" accept=".html" style="display:none" multiple>

<script>
let files = [];
let currentFile = null;

const workspace = document.getElementById("workspace");
const tabs = document.getElementById("tabs");
const modeBox = document.getElementById("modeBox");
const fileInput = document.getElementById("fileInput");

let connectMode=false,disconnectMode=false,sourceNode=null,selectedNode=null;

function newFile(){
  const f={
    id:'f_'+Date.now(),
    name:'Mapa '+(files.length+1),
    nodes:[],
    connections:[]
  };
  files.push(f);
  selectFile(f.id);
}

function selectFile(id){
  currentFile=files.find(f=>f.id===id);
  renderTabs();
  render();
}

function renderTabs(){
  tabs.innerHTML='';
  files.forEach(f=>{
    const t=document.createElement('div');
    t.className='tab'+(f===currentFile?' active':'');
    t.textContent=f.name;
    t.onclick=()=>selectFile(f.id);
    tabs.appendChild(t);
  });
}

function addNode(){
  if(!currentFile)return;
  currentFile.nodes.push({
    id:'n_'+Date.now()+Math.random().toString(36).substr(2,4),
    text:'Nuevo concepto',x:100,y:100
  });
  render();
}

function render(){
  workspace.innerHTML='';
  if(!currentFile)return;
  currentFile.connections.forEach(drawConn);
  currentFile.nodes.forEach(drawNode);
}

function drawNode(node){
  const el=document.createElement('div');
  el.className='node';
  el.style.left=node.x+'px';
  el.style.top=node.y+'px';
  el.textContent=node.text;
  el.dataset.id=node.id;

  el.onmousedown=startDrag;
  el.ondblclick=()=>{el.contentEditable=true;el.focus()};
  el.onblur=()=>{el.contentEditable=false;node.text=el.innerText};

  el.onclick=(e)=>{
    document.querySelectorAll('.node').forEach(n=>n.classList.remove('selected'));
    el.classList.add('selected');
    selectedNode=node;
    handleConnect(node);
    e.stopPropagation();
  };

  workspace.appendChild(el);
}

function drawConn(c){
  const A=currentFile.nodes.find(n=>n.id===c.from);
  const B=currentFile.nodes.find(n=>n.id===c.to);
  if(!A||!B)return;

  const ax=A.x+60,ay=A.y+20,bx=B.x+60,by=B.y+20;
  const dx=bx-ax,dy=by-ay,len=Math.hypot(dx,dy);
  const angle=Math.atan2(dy,dx)*180/Math.PI;

  const line=document.createElement('div');
  line.className='connection';
  line.style.width=len+'px';
  line.style.left=ax+'px';
  line.style.top=ay+'px';
  line.style.transform=`rotate(${angle}deg)`;

  const arrow=document.createElement('div');
  arrow.className='arrow';
  arrow.style.left=(bx-10)+'px';
  arrow.style.top=(by-6)+'px';
  arrow.style.transform=`rotate(${angle}deg)`;

  const label=document.createElement('div');
  label.className='label';
  label.textContent=c.label||'';
  label.style.left=((ax+bx)/2)+'px';
  label.style.top=((ay+by)/2)+'px';

  if(disconnectMode){
    line.style.pointerEvents='auto';
    arrow.style.pointerEvents='auto';
    line.onclick=()=>deleteConn(c);
    arrow.onclick=()=>deleteConn(c);
  }

  workspace.appendChild(line);
  workspace.appendChild(arrow);
  workspace.appendChild(label);
}

function startDrag(e){
  const el=e.target;
  const node=currentFile.nodes.find(n=>n.id===el.dataset.id);
  let ox=e.offsetX,oy=e.offsetY;

  function move(ev){
    node.x=ev.pageX-workspace.offsetLeft-ox;
    node.y=ev.pageY-workspace.offsetTop-oy;
    render();
  }
  document.addEventListener('mousemove',move);
  document.addEventListener('mouseup',()=>document.removeEventListener('mousemove',move),{once:true});
}

function toggleConnect(){
  connectMode=!connectMode;
  disconnectMode=false;
  sourceNode=null;
  modeBox.style.display=connectMode?'block':'none';
  modeBox.textContent='Selecciona nodo origen';
}

function toggleDisconnect(){
  disconnectMode=!disconnectMode;
  connectMode=false;
  sourceNode=null;
  modeBox.style.display=disconnectMode?'block':'none';
  modeBox.textContent='Click en conexi√≥n para borrar';
  render();
}

function handleConnect(node){
  if(!connectMode)return;
  if(!sourceNode){
    sourceNode=node;
    modeBox.textContent='Selecciona nodo destino';
    return;
  }
  if(sourceNode.id===node.id)return;
  const label=prompt('Texto de relaci√≥n:','');
  currentFile.connections.push({from:sourceNode.id,to:node.id,label});
  connectMode=false;sourceNode=null;modeBox.style.display='none';
  render();
}

function deleteConn(c){
  currentFile.connections=currentFile.connections.filter(x=>x!==c);
  disconnectMode=false;
  modeBox.style.display='none';
  render();
}

function deleteNode(){
  if(!selectedNode||!currentFile)return;
  currentFile.nodes=currentFile.nodes.filter(n=>n!==selectedNode);
  currentFile.connections=currentFile.connections.filter(c=>
    c.from!==selectedNode.id&&c.to!==selectedNode.id
  );
  selectedNode=null;
  render();
}

function openFile(){
  fileInput.click();
}

fileInput.onchange=function(){
  [...this.files].forEach(f=>{
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=JSON.parse(e.target.result.match(/\{[\s\S]*\}/)[0]);
        const nf={id:'f_'+Date.now()+Math.random(),name:f.name,nodes:data.nodes,connections:data.connections};
        files.push(nf);
        selectFile(nf.id);
      }catch{alert('Archivo no v√°lido')}
    };
    reader.readAsText(f);
  });
};

function saveFile(){
  if(!currentFile)return;
  const data={nodes:currentFile.nodes,connections:currentFile.connections};
  const html=`<html><body><pre>${JSON.stringify(data,null,2)}</pre></body></html>`;
  const blob=new Blob([html],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=currentFile.name+'.html';
  a.click();
}
</script>
</body>
</html>
