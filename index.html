<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo Arte y Ciencias Sociales</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 13px;
            color: #e6e6e6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #16213e;
            border-radius: 6.5px;
            padding: 13px;
            box-shadow: 0 1.3px 6.5px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 13px;
        }

        .header {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .title-input {
            background: transparent;
            border: none;
            text-align: center;
            color: #e6e6e6;
            font-size: 18px;
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 20px;
            border-radius: 4px;
            width: 80%;
            max-width: 800px;
            background: #4a235a;
        }

        .title-input:focus {
            outline: 2px solid #8e44ad;
            background: #5b2b6b;
        }

        .content {
            display: flex;
            gap: 13px;
        }

        .sidebar {
            width: 160px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .btn {
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.2s ease;
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            background: #4a235a;
            color: #ffffff;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 1.3px 5.2px rgba(0,0,0,0.3);
            background: #5b2b6b;
        }

        .btn-primary { background: #4a235a; }
        .btn-success { background: #5b2b6b; }
        .btn-warning { background: #6c3483; }
        .btn-info { background: #7d3c98; }
        .btn-export { background: #8e44ad; }
        .btn-preview { background: #9b59b6; }
        .btn-danger { background: #a569bd; }
        .btn-bg { background: #af7ac5; }
        .btn-png { background: #bb8fce; }
        .btn-undo { background: #d35400; }
        .btn-disconnect { background: #c0392b; }
        .btn-open { background: #16a085; }
        .btn-save { background: #27ae60; }

        .workspace-container {
            position: relative;
            flex: 1;
            height: 600px;
            overflow: hidden;
            border: 1.3px solid #2d3748;
            border-radius: 5.2px;
            margin-bottom: 13px;
            background: #1a1a2e;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .a4-container {
            width: 1123px;
            height: 794px;
            background: white;
            box-shadow: 0 0 0 2px #8e44ad;
            position: relative;
            overflow: hidden;
        }

        .workspace {
            position: relative;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            transition: transform 0.3s ease;
        }

        .node {
            position: absolute;
            min-width: 80px;
            max-width: 120px;
            padding: 8px;
            background: #1e293b;
            border-radius: 5.2px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 1.3px 5.2px rgba(0,0,0,0.3);
            border: 1.3px solid #4a5568;
            user-select: none;
            transition: all 0.2s ease;
            z-index: 10;
            color: #e6e6e6;
        }

        .node.small { font-size: 0.7em; }
        .node.medium { font-size: 0.85em; }
        .node.large { font-size: 1em; }

        .node:hover {
            transform: scale(1.03);
            box-shadow: 0 2.6px 7.8px rgba(0,0,0,0.4);
        }

        .node.dragging {
            transform: scale(1.05);
            box-shadow: 0 3.9px 13px rgba(0,0,0,0.5);
            z-index: 1000;
            cursor: grabbing;
        }

        .node.selected {
            box-shadow: 0 0 0 2px #8e44ad;
        }

        .node-main {
            border-color: #8e44ad;
        }

        .node-title {
            font-weight: 600;
            margin-bottom: 1.3px;
            line-height: 1.2;
        }

        .node-subtitle {
            font-weight: 500;
            margin-bottom: 5.2px;
            font-style: italic;
            line-height: 1.2;
            opacity: 0.8;
        }

        .connection {
            position: absolute;
            background: #718096;
            height: 2px;
            transform-origin: 0 0;
            pointer-events: none;
            z-index: 5;
        }

        .connection.selected {
            background: #e74c3c;
            height: 3px;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #718096;
            transform-origin: center;
            pointer-events: none;
            z-index: 6;
        }

        .connection-arrow.selected {
            border-top-color: #e74c3c;
        }

        .connection-mode {
            background: #744210;
            color: #fef3c7;
            padding: 5.2px;
            border-radius: 2.6px;
            text-align: center;
            margin-bottom: 5.2px;
            display: none;
            font-weight: bold;
            font-size: 8.45px;
        }

        .disconnect-mode {
            background: #7b241c;
            color: #fadbd8;
            padding: 5.2px;
            border-radius: 2.6px;
            text-align: center;
            margin-bottom: 5.2px;
            display: none;
            font-weight: bold;
            font-size: 8.45px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #1a1a2e;
            margin: 3.25% auto;
            padding: 19.5px;
            border-radius: 6.5px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 3.25px 16.25px rgba(0,0,0,0.5);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
            animation: zoomIn 0.3s ease;
            transform-origin: center center;
            border: 1px solid #2d3748;
            color: #e6e6e6;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { 
                opacity: 0;
                transform: scale(0.8);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }

        .close-modal {
            position: absolute;
            right: 10.4px;
            top: 10.4px;
            font-size: 15.6px;
            font-weight: bold;
            cursor: pointer;
            color: #a0aec0;
            background: none;
            border: none;
            padding: 0;
            width: 19.5px;
            height: 19.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #e6e6e6;
        }

        .modal-title {
            font-family: 'EB Garamond', serif;
            font-size: 18.2px;
            margin-bottom: 6.5px;
            color: #e6e6e6;
        }

        .modal-subtitle {
            font-family: 'EB Garamond', serif;
            font-size: 9.1px;
            margin-bottom: 10.4px;
            color: #a0aec0;
            font-style: italic;
        }

        .modal-author {
            font-family: 'Calibri', sans-serif;
            font-size: 7.8px;
            margin-bottom: 13px;
            color: #a0aec0;
            font-style: italic;
        }

        .modal-image {
            max-width: 100%;
            max-height: 195px;
            margin: 10.4px 0;
            border-radius: 5.2px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .modal-description {
            font-family: 'Calibri', sans-serif;
            font-size: 10.4px;
            line-height: 1.6;
            color: #e6e6e6;
            padding: 13px;
            background: #2d3748;
            border-radius: 3.25px;
        }

        .form-group {
            margin-bottom: 7.8px;
        }

        label {
            display: block;
            margin-bottom: 2.6px;
            font-weight: bold;
            color: #e6e6e6;
            font-size: 8.45px;
        }

        input, select, textarea {
            width: 100%;
            padding: 5.2px;
            border: 0.65px solid #4a5568;
            border-radius: 2.6px;
            font-size: 8.45px;
            background: #2d3748;
            color: #e6e6e6;
        }

        .image-preview {
            max-width: 100%;
            max-height: 97.5px;
            margin-top: 6.5px;
            border-radius: 2.6px;
            display: none;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #1a1a2e;
            border-radius: 5px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 20;
            border: 1px solid #2d3748;
        }

        .zoom-controls button {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 2px;
            background: #4a235a;
            color: #e6e6e6;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .zoom-controls button:hover {
            background: #5b2b6b;
        }

        .info-panel {
            background: #2d3748;
            padding: 10.4px;
            border-radius: 5.2px;
            margin-bottom: 10.4px;
            font-size: 0.65em;
        }

        .info-panel h3 {
            font-family: 'Calibri', 'Candara', 'Segoe', 'Segoe UI', sans-serif;
            font-weight: 600;
            color: #e6e6e6;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .preview-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-print {
            background: #1a5089;
            color: white;
        }

        .color-picker-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .color-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-input-group label {
            min-width: 60px;
            margin-bottom: 0;
        }

        .color-input-group input {
            flex: 1;
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            border: 1px solid #2d3748;
        }

        .node-customization {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #2d3748;
            border-radius: 5px;
        }

        .customization-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .customization-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .font-size-option, .text-color-option, .font-family-option, .border-option {
            padding: 5px 8px;
            border: 1px solid #4a5568;
            border-radius: 3px;
            cursor: pointer;
            font-size: 9px;
            text-align: center;
            flex: 1;
            min-width: 60px;
        }

        .font-size-option.active, .text-color-option.active, .font-family-option.active, .border-option.active {
            border-color: #8e44ad;
            background: rgba(142, 68, 173, 0.2);
        }

        .transparent-bg {
            background: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                        linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #ccc 75%), 
                        linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 10px 10px;
            background-position: 0 0, 0 5px, 5px -5px, -5px 0px;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .workspace-container {
                height: 500px;
            }
            
            .a4-container {
                width: 95%;
                height: 400px;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
            
            .node {
                min-width: 70px;
                padding: 6px;
            }
            
            .modal-content {
                margin: 1.3% auto;
                width: 95%;
                padding: 13px;
            }
        }

        .file-input-hidden {
            display: none;
        }

        .save-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .save-options button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <input type="text" class="title-input" id="mapTitle" value="MAPA INTERACTIVO ARTE Y CIENCIAS SOCIALES" onchange="updateMapTitle(this.value)">
        </div>
        
        <div class="content">
            <div class="sidebar">
                <button class="btn btn-primary" onclick="showNodeModal()">
                    NODO
                </button>
                <button class="btn btn-info" onclick="startConnection()">
                    CONECTAR
                </button>
                <button class="btn btn-warning" onclick="editSelectedNode()">
                    EDITAR NODO
                </button>
                <button class="btn btn-disconnect" onclick="startDisconnect()">
                    DESCONECTAR
                </button>
                <button class="btn btn-undo" onclick="undoAction()">
                    DESHACER
                </button>
                <button class="btn btn-preview" onclick="openPreviewModal()">
                    VISTA PREVIA
                </button>
                <button class="btn btn-save" onclick="showSaveModal()">
                    GUARDAR
                </button>
                <button class="btn btn-open" onclick="document.getElementById('fileInput').click()">
                    ABRIR HTML
                </button>
                <button class="btn btn-bg" onclick="showBackgroundModal()">
                    FONDO
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedNode()">
                    BORRAR NODO
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    LIMPIAR TODO
                </button>
            </div>

            <!-- Input oculto para abrir archivos -->
            <input type="file" id="fileInput" class="file-input-hidden" accept=".html" onchange="loadFromHTML(this.files[0])">

            <div class="main-content">
                <div class="connection-mode" id="connectionMode">
                    üîó Modo Conexi√≥n: Selecciona el nodo destino
                </div>
                
                <div class="disconnect-mode" id="disconnectMode">
                    ‚ùå Modo Desconexi√≥n: Selecciona una conexi√≥n para eliminar
                </div>

                <div class="workspace-container" id="workspaceContainer">
                    <div class="a4-container" id="a4Container">
                        <div class="workspace" id="workspace">
                            <!-- Los nodos y conexiones se crear√°n aqu√≠ -->
                        </div>
                    </div>
                    <div class="zoom-controls">
                        <button onclick="zoomIn()">+</button>
                        <button onclick="zoomOut()">-</button>
                        <button onclick="resetZoom()">‚ü≥</button>
                    </div>
                </div>

                <div class="info-panel">
                    <h3>üí° INFORMACI√ìN DEL MAPA</h3>
                    <div id="nodeInfo">
                        <p>Haz doble click en cualquier nodo para ver sus opciones</p>
                        <p>Total de nodos: <span id="nodesCount">0</span> | Conexiones: <span id="connectionsCount">0</span></p>
                        <p>Acciones disponibles para deshacer: <span id="undoCount">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear/editar nodo -->
    <div id="nodeModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeNodeModal()">&times;</button>
            <h3 class="modal-title" id="nodeModalTitle">CREAR NUEVO NODO</h3>
            <div class="form-group">
                <label for="nodeTitle">T√çTULO:</label>
                <input type="text" id="nodeTitle" placeholder="Ej: Inteligencia Artificial">
            </div>
            <div class="form-group">
                <label for="nodeSubtitle">SUBT√çTULO:</label>
                <input type="text" id="nodeSubtitle" placeholder="Ej: Definici√≥n y conceptos b√°sicos">
            </div>
            <div class="form-group">
                <label for="nodeAuthor">TEXTO O AUTOR:</label>
                <input type="text" id="nodeAuthor" placeholder="Ej: Roger Charnier (1990)">
            </div>
            <div class="form-group">
                <label for="nodeDescription">DESCRIPCI√ìN:</label>
                <textarea id="nodeDescription" placeholder="Ej: La inteligencia artificial es el campo de la inform√°tica que se centra en la creaci√≥n de sistemas que pueden realizar tareas que normalmente requieren inteligencia humana..." rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="nodeImage">IMAGEN (OPCIONAL):</label>
                <input type="file" id="nodeImage" accept="image/*" onchange="previewImage(this)">
                <img id="imagePreview" class="image-preview" alt="Vista previa de imagen">
            </div>
            
            <div class="node-customization">
                <h4 style="font-size: 11px; margin-bottom: 8px;">PERSONALIZACI√ìN DEL NODO</h4>
                
                <div class="customization-group">
                    <label>COLOR DE FONDO:</label>
                    <button class="btn" onclick="showColorPickerModal('node')" style="width: 100%; margin-bottom: 10px;">SELECCIONAR COLOR</button>
                    <div class="color-input-group">
                        <label>Color:</label>
                        <div id="nodeColorPreview" class="color-preview" style="background: #4a235a;"></div>
                    </div>
                </div>
                
                <div class="customization-group">
                    <label>BORDE:</label>
                    <div class="customization-row">
                        <div class="border-option active" onclick="selectBorder('solid', this)">CON BORDE</div>
                        <div class="border-option" onclick="selectBorder('none', this)">SIN BORDE</div>
                    </div>
                </div>
                
                <div class="customization-group">
                    <label>COLOR DE TEXTO:</label>
                    <div class="customization-row">
                        <div class="text-color-option active" onclick="selectTextColor('white', this)">BLANCO</div>
                        <div class="text-color-option" onclick="selectTextColor('black', this)">NEGRO</div>
                    </div>
                </div>
                
                <div class="customization-group">
                    <label>TAMA√ëO DE LETRA:</label>
                    <div class="customization-row">
                        <div class="font-size-option active" onclick="selectFontSize('small', this)">PEQUE√ëO</div>
                        <div class="font-size-option" onclick="selectFontSize('medium', this)">MEDIANO</div>
                        <div class="font-size-option" onclick="selectFontSize('large', this)">GRANDE</div>
                    </div>
                </div>
                
                <div class="customization-group">
                    <label>TIPOGRAF√çA:</label>
                    <div class="customization-row">
                        <div class="font-family-option active" onclick="selectFontFamily('EB Garamond', this)" style="font-family: 'EB Garamond'">GARAMOND</div>
                        <div class="font-family-option" onclick="selectFontFamily('Roboto', this)" style="font-family: 'Roboto'">ROBOTO</div>
                        <div class="font-family-option" onclick="selectFontFamily('Open Sans', this)" style="font-family: 'Open Sans'">OPEN SANS</div>
                        <div class="font-family-option" onclick="selectFontFamily('Montserrat', this)" style="font-family: 'Montserrat'">MONTSERRAT</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="saveNode()" style="flex: 1;">GUARDAR NODO</button>
                <button class="btn btn-danger" onclick="closeNodeModal()" style="flex: 1;">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Modal para descripci√≥n -->
    <div id="descriptionModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <h3 class="modal-subtitle" id="modalSubtitle"></h3>
            <div class="modal-author" id="modalAuthor"></div>
            <img id="modalImage" class="modal-image" style="display: none;" alt="Imagen del nodo">
            <div class="modal-description" id="modalDescription"></div>
        </div>
    </div>

    <!-- Modal para guardar -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSaveModal()">&times;</button>
            <h3 class="modal-title">GUARDAR MAPA</h3>
            <p>Selecciona el formato en el que deseas guardar tu mapa:</p>
            
            <div class="save-options">
                <button class="btn btn-primary" onclick="downloadHTML()">GUARDAR COMO HTML</button>
                <button class="btn btn-png" onclick="exportToPNG()">GUARDAR COMO PNG</button>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-danger" onclick="closeSaveModal()" style="width: 100%;">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Modal para vista previa -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closePreviewModal()">&times;</button>
            <h3 class="modal-title">VISTA PREVIA DEL MAPA</h3>
            <div id="previewContent" style="border: 1px solid #4a5568; border-radius: 5px; padding: 10px; background: #1a1a2e; min-height: 400px; overflow: auto;">
                <!-- Contenido de la vista previa -->
            </div>
            <div class="preview-actions">
                <button class="btn-print" onclick="printPreview()">IMPRIMIR</button>
                <button class="btn btn-danger" onclick="closePreviewModal()">CERRAR</button>
            </div>
        </div>
    </div>

    <!-- Modal para seleccionar color de fondo -->
    <div id="backgroundModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeBackgroundModal()">&times;</button>
            <h3 class="modal-title">CONFIGURACI√ìN DE FONDO</h3>
            
            <div class="form-group">
                <label>COLOR DE FONDO:</label>
                <button class="btn" onclick="showColorPickerModal('background')" style="width: 100%; margin-bottom: 10px;">SELECCIONAR COLOR</button>
                <div class="color-input-group">
                    <label>Color actual:</label>
                    <div id="bgColorPreview" class="color-preview" style="background: #ffffff;"></div>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="applyBackground()" style="flex: 1;">APLICAR</button>
                <button class="btn btn-danger" onclick="closeBackgroundModal()" style="flex: 1;">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- Modal para selector de color personalizado -->
    <div id="colorPickerModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeColorPickerModal()">&times;</button>
            <h3 class="modal-title" id="colorPickerTitle">SELECCIONAR COLOR</h3>
            
            <div class="color-picker-container">
                <div class="color-input-group">
                    <label>R:</label>
                    <input type="range" id="colorR" min="0" max="255" value="74" oninput="updateCustomColor()">
                    <input type="number" id="colorRValue" min="0" max="255" value="74" oninput="updateCustomColorFromInput()">
                </div>
                
                <div class="color-input-group">
                    <label>G:</label>
                    <input type="range" id="colorG" min="0" max="255" value="35" oninput="updateCustomColor()">
                    <input type="number" id="colorGValue" min="0" max="255" value="35" oninput="updateCustomColorFromInput()">
                </div>
                
                <div class="color-input-group">
                    <label>B:</label>
                    <input type="range" id="colorB" min="0" max="255" value="90" oninput="updateCustomColor()">
                    <input type="number" id="colorBValue" min="0" max="255" value="90" oninput="updateCustomColorFromInput()">
                </div>
                
                <div class="color-input-group">
                    <label>Color:</label>
                    <div id="customColorPreview" class="color-preview" style="background: rgb(74, 35, 90);"></div>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn btn-success" onclick="applyCustomColor()" style="flex: 1;">APLICAR</button>
                <button class="btn btn-danger" onclick="closeColorPickerModal()" style="flex: 1;">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let nodes = [];
        let connections = [];
        let connectionMode = false;
        let disconnectMode = false;
        let sourceNodeId = null;
        let nodeCounter = 0;
        let currentImage = null;
        let editingNodeId = null;
        let selectedNodeId = null;
        let selectedConnection = null;
        let zoomLevel = 1;
        let translateX = 0, translateY = 0;
        
        // Variables de personalizaci√≥n de nodo
        let selectedNodeColor = '#4a235a';
        let selectedTextColor = 'white';
        let selectedFontSize = 'small';
        let selectedFontFamily = 'EB Garamond';
        let selectedBorder = 'solid';
        
        // Historial para deshacer acciones
        let history = [];
        let historyIndex = -1;
        
        // Variables para el selector de color personalizado
        let currentColorPickerType = null;
        let customColor = { r: 74, g: 35, b: 90 };

        // Elementos DOM
        const workspace = document.getElementById('workspace');
        const a4Container = document.getElementById('a4Container');
        const connectionModeDiv = document.getElementById('connectionMode');
        const disconnectModeDiv = document.getElementById('disconnectMode');
        const nodeInfo = document.getElementById('nodeInfo');

        // Actualizar t√≠tulo del mapa
        function updateMapTitle(title) {
            document.title = title + " - Mapa Interactivo";
        }

        // Guardar estado actual en el historial
        function saveState() {
            // Eliminar estados futuros si estamos en medio del historial
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            // Guardar estado actual
            history.push({
                nodes: JSON.parse(JSON.stringify(nodes)),
                connections: JSON.parse(JSON.stringify(connections))
            });
            
            historyIndex = history.length - 1;
            
            // Limitar el historial a 50 estados para evitar uso excesivo de memoria
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
            
            updateUndoCount();
        }

        // Deshacer √∫ltima acci√≥n
        function undoAction() {
            if (historyIndex > 0) {
                historyIndex--;
                const state = history[historyIndex];
                nodes = JSON.parse(JSON.stringify(state.nodes));
                connections = JSON.parse(JSON.stringify(state.connections));
                
                renderAll();
                updateCounters();
                updateUndoCount();
                
                // Deseleccionar cualquier elemento seleccionado
                selectedNodeId = null;
                selectedConnection = null;
            } else {
                alert("No hay m√°s acciones para deshacer");
            }
        }

        // Actualizar contador de acciones deshacer
        function updateUndoCount() {
            document.getElementById('undoCount').textContent = historyIndex;
        }

        // Modal functions
        function showNodeModal() {
            document.getElementById('nodeModal').style.display = 'block';
            document.getElementById('nodeModalTitle').textContent = 'CREAR NUEVO NODO';
            clearNodeForm();
            editingNodeId = null;
        }

        function closeNodeModal() {
            document.getElementById('nodeModal').style.display = 'none';
            editingNodeId = null;
        }

        function showSaveModal() {
            document.getElementById('saveModal').style.display = 'block';
        }

        function closeSaveModal() {
            document.getElementById('saveModal').style.display = 'none';
        }

        function openPreviewModal() {
            document.getElementById('previewModal').style.display = 'block';
            updatePreviewContent();
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('descriptionModal').style.display = 'none';
        }

        function showBackgroundModal() {
            document.getElementById('backgroundModal').style.display = 'block';
        }

        function closeBackgroundModal() {
            document.getElementById('backgroundModal').style.display = 'none';
        }

        function showColorPickerModal(type) {
            currentColorPickerType = type;
            document.getElementById('colorPickerModal').style.display = 'block';
            
            if (type === 'node') {
                document.getElementById('colorPickerTitle').textContent = 'COLOR DE FONDO DEL NODO';
            } else if (type === 'background') {
                document.getElementById('colorPickerTitle').textContent = 'COLOR DE FONDO DEL MAPA';
            }
        }

        function closeColorPickerModal() {
            document.getElementById('colorPickerModal').style.display = 'none';
            currentColorPickerType = null;
        }

        // Cambiar color de fondo del mapa
        function changeMapBackground(color) {
            a4Container.style.backgroundColor = color;
            document.getElementById('bgColorPreview').style.backgroundColor = color;
        }

        // Aplicar configuraci√≥n de fondo
        function applyBackground() {
            // Guardar estado antes de cambiar el fondo
            saveState();
            closeBackgroundModal();
        }

        // Vista previa de imagen
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    currentImage = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
                currentImage = null;
            }
        }

        // Actualizar color personalizado
        function updateCustomColor() {
            customColor.r = parseInt(document.getElementById('colorR').value);
            customColor.g = parseInt(document.getElementById('colorG').value);
            customColor.b = parseInt(document.getElementById('colorB').value);
            
            document.getElementById('colorRValue').value = customColor.r;
            document.getElementById('colorGValue').value = customColor.g;
            document.getElementById('colorBValue').value = customColor.b;
            
            const preview = document.getElementById('customColorPreview');
            preview.style.backgroundColor = `rgb(${customColor.r}, ${customColor.g}, ${customColor.b})`;
        }

        // Actualizar color personalizado desde inputs num√©ricos
        function updateCustomColorFromInput() {
            customColor.r = parseInt(document.getElementById('colorRValue').value);
            customColor.g = parseInt(document.getElementById('colorGValue').value);
            customColor.b = parseInt(document.getElementById('colorBValue').value);
            
            document.getElementById('colorR').value = customColor.r;
            document.getElementById('colorG').value = customColor.g;
            document.getElementById('colorB').value = customColor.b;
            
            const preview = document.getElementById('customColorPreview');
            preview.style.backgroundColor = `rgb(${customColor.r}, ${customColor.g}, ${customColor.b})`;
        }

        // Aplicar color personalizado
        function applyCustomColor() {
            const color = `rgb(${customColor.r}, ${customColor.g}, ${customColor.b})`;
            
            if (currentColorPickerType === 'node') {
                selectedNodeColor = color;
                document.getElementById('nodeColorPreview').style.backgroundColor = color;
            } else if (currentColorPickerType === 'background') {
                changeMapBackground(color);
            }
            
            closeColorPickerModal();
        }

        // Personalizaci√≥n de nodos
        function selectBorder(border, element) {
            selectedBorder = border;
            document.querySelectorAll('.border-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        function selectTextColor(color, element) {
            selectedTextColor = color;
            document.querySelectorAll('.text-color-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        function selectFontSize(size, element) {
            selectedFontSize = size;
            document.querySelectorAll('.font-size-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        function selectFontFamily(font, element) {
            selectedFontFamily = font;
            document.querySelectorAll('.font-family-option').forEach(opt => {
                opt.classList.remove('active');
            });
            element.classList.add('active');
        }

        // Exportar a PNG
        function exportToPNG() {
            // Guardar el estado actual del zoom y transformaci√≥n
            const originalZoom = zoomLevel;
            const originalTranslateX = translateX;
            const originalTranslateY = translateY;
            
            // Restablecer el zoom y posici√≥n temporalmente
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateWorkspaceTransform();
            
            // Esperar un momento para que se aplique la transformaci√≥n
            setTimeout(() => {
                html2canvas(a4Container, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: a4Container.style.backgroundColor || '#ffffff'
                }).then(canvas => {
                    // Crear un enlace de descarga
                    const link = document.createElement('a');
                    link.download = 'mapa-interactivo.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Restaurar el zoom y posici√≥n original despu√©s de exportar
                    zoomLevel = originalZoom;
                    translateX = originalTranslateX;
                    translateY = originalTranslateY;
                    updateWorkspaceTransform();
                    
                    closeSaveModal();
                });
            }, 500);
        }

        // Limpiar formulario
        function clearNodeForm() {
            document.getElementById('nodeTitle').value = '';
            document.getElementById('nodeSubtitle').value = '';
            document.getElementById('nodeAuthor').value = '';
            document.getElementById('nodeDescription').value = '';
            document.getElementById('nodeImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            currentImage = null;
            
            // Resetear personalizaci√≥n a valores por defecto
            selectedNodeColor = '#4a235a';
            selectedTextColor = 'white';
            selectedFontSize = 'small';
            selectedFontFamily = 'EB Garamond';
            selectedBorder = 'solid';
            
            updateCustomizationSelectors();
        }

        // Actualizar selectores de personalizaci√≥n
        function updateCustomizationSelectors() {
            document.getElementById('nodeColorPreview').style.backgroundColor = selectedNodeColor;
            
            document.querySelectorAll('.border-option').forEach(opt => {
                opt.classList.remove('active');
                if ((selectedBorder === 'solid' && opt.textContent === 'CON BORDE') ||
                    (selectedBorder === 'none' && opt.textContent === 'SIN BORDE')) {
                    opt.classList.add('active');
                }
            });
            
            document.querySelectorAll('.text-color-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.textContent === selectedTextColor.toUpperCase()) {
                    opt.classList.add('active');
                }
            });
            
            document.querySelectorAll('.font-size-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.textContent === getFontSizeLabel(selectedFontSize)) {
                    opt.classList.add('active');
                }
            });
            
            document.querySelectorAll('.font-family-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.textContent === getFontFamilyLabel(selectedFontFamily)) {
                    opt.classList.add('active');
                }
            });
        }

        // Obtener etiqueta del tama√±o de fuente
        function getFontSizeLabel(size) {
            switch(size) {
                case 'small': return 'PEQUE√ëO';
                case 'medium': return 'MEDIANO';
                case 'large': return 'GRANDE';
                default: return 'PEQUE√ëO';
            }
        }

        // Obtener etiqueta de la familia de fuentes
        function getFontFamilyLabel(font) {
            switch(font) {
                case 'EB Garamond': return 'GARAMOND';
                case 'Roboto': return 'ROBOTO';
                case 'Open Sans': return 'OPEN SANS';
                case 'Montserrat': return 'MONTSERRAT';
                default: return 'GARAMOND';
            }
        }

        // Guardar nodo (crear o editar)
        function saveNode() {
            const title = document.getElementById('nodeTitle').value.trim();
            const subtitle = document.getElementById('nodeSubtitle').value.trim();
            const author = document.getElementById('nodeAuthor').value.trim();
            const description = document.getElementById('nodeDescription').value.trim();

            if (!title) {
                alert('Por favor ingresa un t√≠tulo');
                return;
            }

            // Guardar estado actual antes de realizar cambios
            saveState();

            if (editingNodeId) {
                // Editar nodo existente
                const node = nodes.find(n => n.id === editingNodeId);
                if (node) {
                    node.title = title;
                    node.subtitle = subtitle;
                    node.author = author;
                    node.description = description;
                    node.image = currentImage;
                    node.color = selectedNodeColor;
                    node.textColor = selectedTextColor;
                    node.fontSize = selectedFontSize;
                    node.fontFamily = selectedFontFamily;
                    node.border = selectedBorder;
                    
                    // Re-renderizar el nodo
                    renderAll();
                }
            } else {
                // Crear nuevo nodo
                nodeCounter++;
                const nodeId = 'node-' + nodeCounter;

                // Posici√≥n aleatoria en el workspace A4
                const x = Math.random() * (a4Container.offsetWidth - 100) + 20;
                const y = Math.random() * (a4Container.offsetHeight - 60) + 20;

                const node = {
                    id: nodeId,
                    title: title,
                    subtitle: subtitle,
                    author: author,
                    description: description,
                    image: currentImage,
                    type: 'main',
                    x: x,
                    y: y,
                    color: selectedNodeColor,
                    textColor: selectedTextColor,
                    fontSize: selectedFontSize,
                    fontFamily: selectedFontFamily,
                    border: selectedBorder
                };

                nodes.push(node);
                renderNode(node);
                updateCounters();
            }

            closeNodeModal();
        }

        // Editar nodo seleccionado - CORREGIDO
        function editSelectedNode() {
            if (!selectedNodeId) {
                alert('Por favor selecciona un nodo primero haciendo clic en √©l');
                return;
            }
            
            const node = nodes.find(n => n.id === selectedNodeId);
            if (!node) return;

            editingNodeId = node.id;
            document.getElementById('nodeModalTitle').textContent = 'EDITAR NODO';
            
            // Llenar formulario con datos existentes del nodo correcto
            document.getElementById('nodeTitle').value = node.title;
            document.getElementById('nodeSubtitle').value = node.subtitle || '';
            document.getElementById('nodeAuthor').value = node.author || '';
            document.getElementById('nodeDescription').value = node.description || '';
            
            // Configurar personalizaci√≥n
            selectedNodeColor = node.color || '#4a235a';
            selectedTextColor = node.textColor || 'white';
            selectedFontSize = node.fontSize || 'small';
            selectedFontFamily = node.fontFamily || 'EB Garamond';
            selectedBorder = node.border || 'solid';
            
            updateCustomizationSelectors();
            
            // Manejar imagen
            const preview = document.getElementById('imagePreview');
            if (node.image) {
                preview.src = node.image;
                preview.style.display = 'block';
                currentImage = node.image;
            } else {
                preview.style.display = 'none';
                currentImage = null;
            }
            
            document.getElementById('nodeModal').style.display = 'block';
        }

        // Eliminar nodo seleccionado - CORREGIDO
        function deleteSelectedNode() {
            if (!selectedNodeId) {
                alert('Por favor selecciona un nodo primero haciendo clic en √©l');
                return;
            }

            if (!confirm('¬øEst√°s seguro de que quieres eliminar este nodo?')) return;

            // Guardar estado actual antes de eliminar
            saveState();

            // Eliminar conexiones relacionadas
            connections = connections.filter(conn => 
                conn.from !== selectedNodeId && conn.to !== selectedNodeId
            );

            // Eliminar nodo correcto
            const nodeIndex = nodes.findIndex(n => n.id === selectedNodeId);
            if (nodeIndex !== -1) {
                nodes.splice(nodeIndex, 1);
            }
            
            selectedNodeId = null;
            
            // Re-renderizar
            renderAll();
            updateCounters();
        }

        // Mostrar modal de descripci√≥n
        function showDescriptionModal(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            document.getElementById('modalTitle').textContent = node.title;
            document.getElementById('modalSubtitle').textContent = node.subtitle || 'Sin subt√≠tulo';
            document.getElementById('modalAuthor').textContent = node.author ? `Autor: ${node.author}` : 'Autor no especificado';
            document.getElementById('modalDescription').textContent = node.description || 'Sin descripci√≥n disponible.';
            
            const modalImage = document.getElementById('modalImage');
            if (node.image) {
                modalImage.src = node.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            document.getElementById('descriptionModal').style.display = 'block';
        }

        // Cargar desde archivo HTML
        function loadFromHTML(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // Extraer datos del HTML
                    const nodesMatch = content.match(/const nodes = (\[.*?\]);/s);
                    const connectionsMatch = content.match(/const connections = (\[.*?\]);/s);
                    
                    if (nodesMatch && connectionsMatch) {
                        // Parsear los datos
                        const newNodes = JSON.parse(nodesMatch[1]);
                        const newConnections = JSON.parse(connectionsMatch[1]);
                        
                        // Guardar estado actual antes de cargar
                        saveState();
                        
                        // Actualizar datos
                        nodes = newNodes;
                        connections = newConnections;
                        
                        // Actualizar contador de nodos
                        nodeCounter = nodes.length;
                        
                        // Re-renderizar
                        renderAll();
                        updateCounters();
                        
                        alert('‚úÖ Mapa cargado correctamente');
                    } else {
                        alert('‚ùå El archivo no contiene datos v√°lidos del mapa');
                    }
                } catch (error) {
                    alert('‚ùå Error al cargar el archivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Cerrar modal al hacer click fuera
        window.addEventListener('click', function(event) {
            const modals = ['nodeModal', 'descriptionModal', 'saveModal', 'previewModal', 'backgroundModal', 'colorPickerModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'nodeModal') closeNodeModal();
                    else if (modalId === 'descriptionModal') closeModal();
                    else if (modalId === 'saveModal') closeSaveModal();
                    else if (modalId === 'previewModal') closePreviewModal();
                    else if (modalId === 'backgroundModal') closeBackgroundModal();
                    else if (modalId === 'colorPickerModal') closeColorPickerModal();
                }
            });
        });

        // Renderizar nodo en el workspace
        function renderNode(node) {
            const nodeElement = document.createElement('div');
            nodeElement.className = `node node-main ${node.fontSize || 'small'}`;
            nodeElement.id = node.id;
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            nodeElement.style.fontFamily = node.fontFamily || 'EB Garamond';
            
            // Aplicar color de fondo (incluyendo transparente)
            if (node.color === 'transparent') {
                nodeElement.style.background = 'transparent';
            } else {
                nodeElement.style.background = node.color || '#4a235a';
            }
            
            // Aplicar borde
            if (node.border === 'none') {
                nodeElement.style.border = 'none';
            } else {
                nodeElement.style.border = '1.3px solid #8e44ad';
            }
            
            nodeElement.style.color = node.textColor || 'white';
            
            nodeElement.innerHTML = `
                <div class="node-title">${node.title}</div>
                ${node.subtitle ? `<div class="node-subtitle">${node.subtitle}</div>` : ''}
            `;

            // Hacer arrastrable
            makeDraggable(nodeElement, node);

            // Evento click simple para selecci√≥n
            nodeElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                // Si estamos en modo desconexi√≥n, no seleccionar nodos
                if (disconnectMode) return;
                
                // Deseleccionar nodo anterior
                if (selectedNodeId) {
                    const prevNode = document.getElementById(selectedNodeId);
                    if (prevNode) prevNode.classList.remove('selected');
                }
                
                // Deseleccionar conexi√≥n si hab√≠a una seleccionada
                if (selectedConnection) {
                    const line = document.getElementById('conn-' + selectedConnection.from + '-' + selectedConnection.to);
                    const arrow = document.getElementById('arrow-' + selectedConnection.from + '-' + selectedConnection.to);
                    if (line) line.classList.remove('selected');
                    if (arrow) arrow.classList.remove('selected');
                    selectedConnection = null;
                }
                
                // Seleccionar nuevo nodo
                selectedNodeId = node.id;
                nodeElement.classList.add('selected');
                
                if (connectionMode && sourceNodeId && sourceNodeId !== node.id) {
                    createConnection(sourceNodeId, node.id);
                    setConnectionMode(false);
                } else if (connectionMode && !sourceNodeId) {
                    sourceNodeId = node.id;
                    connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el nodo destino';
                }
            });

            // Evento doble click para mostrar descripci√≥n
            nodeElement.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                if (!connectionMode && !disconnectMode) {
                    showDescriptionModal(node.id);
                }
            });

            workspace.appendChild(nodeElement);
        }

        // Hacer nodo arrastrable
        function makeDraggable(element, node) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', startDrag);

            function startDrag(e) {
                if (e.target.classList.contains('node-btn')) return;
                
                e.preventDefault();
                isDragging = true;
                element.classList.add('dragging');
                
                startX = e.clientX;
                startY = e.clientY;
                initialX = element.offsetLeft;
                initialY = element.offsetTop;
                
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
            }

            function onDrag(e) {
                if (!isDragging) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newX = initialX + dx;
                let newY = initialY + dy;

                // Mantener dentro de los l√≠mites del A4
                newX = Math.max(6.5, Math.min(newX, a4Container.offsetWidth - element.offsetWidth - 6.5));
                newY = Math.max(6.5, Math.min(newY, a4Container.offsetHeight - element.offsetHeight - 6.5));

                element.style.left = newX + 'px';
                element.style.top = newY + 'px';
                
                node.x = newX;
                node.y = newY;

                updateConnections();
            }

            function stopDrag() {
                isDragging = false;
                element.classList.remove('dragging');
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
                
                // Guardar estado despu√©s de mover un nodo
                saveState();
            }
        }

        // Iniciar modo conexi√≥n
        function startConnection() {
            if (nodes.length < 2) {
                alert('Necesitas al menos 2 nodos para crear conexiones');
                return;
            }
            setConnectionMode(true);
            setDisconnectMode(false);
            sourceNodeId = null;
            connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el primer nodo';
        }

        // Activar/desactivar modo conexi√≥n
        function setConnectionMode(active) {
            connectionMode = active;
            if (active) {
                connectionModeDiv.style.display = 'block';
                connectionModeDiv.textContent = 'üîó Modo Conexi√≥n: Selecciona el primer nodo';
            } else {
                connectionModeDiv.style.display = 'none';
                sourceNodeId = null;
            }
        }

        // Iniciar modo desconexi√≥n - CORREGIDO
        function startDisconnect() {
            if (connections.length === 0) {
                alert('No hay conexiones para eliminar');
                return;
            }
            setDisconnectMode(true);
            setConnectionMode(false);
            disconnectModeDiv.textContent = '‚ùå Modo Desconexi√≥n: Selecciona una conexi√≥n para eliminar';
        }

        // Activar/desactivar modo desconexi√≥n - CORREGIDO
        function setDisconnectMode(active) {
            disconnectMode = active;
            if (active) {
                disconnectModeDiv.style.display = 'block';
                disconnectModeDiv.textContent = '‚ùå Modo Desconexi√≥n: Selecciona una conexi√≥n para eliminar';
                
                // Hacer las conexiones clickeables
                connections.forEach(conn => {
                    const line = document.getElementById('conn-' + conn.from + '-' + conn.to);
                    const arrow = document.getElementById('arrow-' + conn.from + '-' + conn.to);
                    
                    if (line && arrow) {
                        line.style.pointerEvents = 'auto';
                        arrow.style.pointerEvents = 'auto';
                        
                        line.addEventListener('click', function() {
                            selectConnection(conn);
                        });
                        
                        arrow.addEventListener('click', function() {
                            selectConnection(conn);
                        });
                    }
                });
            } else {
                disconnectModeDiv.style.display = 'none';
                
                // Restaurar conexiones a no clickeables
                connections.forEach(conn => {
                    const line = document.getElementById('conn-' + conn.from + '-' + conn.to);
                    const arrow = document.getElementById('arrow-' + conn.from + '-' + conn.to);
                    
                    if (line && arrow) {
                        line.style.pointerEvents = 'none';
                        arrow.style.pointerEvents = 'none';
                    }
                });
            }
        }

        // Seleccionar una conexi√≥n
        function selectConnection(conn) {
            if (!disconnectMode) return;
            
            // Deseleccionar conexi√≥n anterior si existe
            if (selectedConnection) {
                const prevLine = document.getElementById('conn-' + selectedConnection.from + '-' + selectedConnection.to);
                const prevArrow = document.getElementById('arrow-' + selectedConnection.from + '-' + selectedConnection.to);
                if (prevLine) prevLine.classList.remove('selected');
                if (prevArrow) prevArrow.classList.remove('selected');
            }
            
            // Deseleccionar nodo si estaba seleccionado
            if (selectedNodeId) {
                const prevNode = document.getElementById(selectedNodeId);
                if (prevNode) prevNode.classList.remove('selected');
                selectedNodeId = null;
            }
            
            // Seleccionar nueva conexi√≥n
            selectedConnection = conn;
            const line = document.getElementById('conn-' + conn.from + '-' + conn.to);
            const arrow = document.getElementById('arrow-' + conn.from + '-' + conn.to);
            
            if (line && arrow) {
                line.classList.add('selected');
                arrow.classList.add('selected');
                
                // Preguntar si desea eliminar la conexi√≥n
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta conexi√≥n?')) {
                    // Guardar estado antes de eliminar
                    saveState();
                    
                    // Eliminar conexi√≥n
                    connections = connections.filter(c => 
                        !(c.from === conn.from && c.to === conn.to)
                    );
                    
                    // Re-renderizar
                    renderAll();
                    updateCounters();
                    
                    // Salir del modo desconexi√≥n si no hay m√°s conexiones
                    if (connections.length === 0) {
                        setDisconnectMode(false);
                    }
                } else {
                    // Deseleccionar si el usuario cancela
                    line.classList.remove('selected');
                    arrow.classList.remove('selected');
                    selectedConnection = null;
                }
            }
        }

        // Crear conexi√≥n entre nodos
        function createConnection(fromId, toId) {
            // Evitar conexiones duplicadas
            const existingConnection = connections.find(conn => 
                (conn.from === fromId && conn.to === toId) || 
                (conn.from === toId && conn.to === fromId)
            );

            if (existingConnection) {
                alert('Estos nodos ya est√°n conectados');
                return;
            }

            if (fromId === toId) {
                alert('No puedes conectar un nodo consigo mismo');
                return;
            }

            // Guardar estado antes de crear conexi√≥n
            saveState();

            connections.push({ from: fromId, to: toId });
            renderConnection(fromId, toId);
            updateCounters();
        }

        // Renderizar conexi√≥n
        function renderConnection(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const toNode = nodes.find(n => n.id === toId);

            if (!fromNode || !toNode) return;

            // Crear l√≠nea
            const line = document.createElement('div');
            line.className = 'connection';
            line.id = 'conn-' + fromId + '-' + toId;

            // Crear flecha
            const arrow = document.createElement('div');
            arrow.className = 'connection-arrow';
            arrow.id = 'arrow-' + fromId + '-' + toId;

            workspace.appendChild(line);
            workspace.appendChild(arrow);

            updateConnection(fromId, toId);
        }

        // Actualizar posici√≥n de conexi√≥n
        function updateConnection(fromId, toId) {
            const fromNode = nodes.find(n => n.id === fromId);
            const toNode = nodes.find(n => n.id === toId);
            const line = document.getElementById('conn-' + fromId + '-' + toId);
            const arrow = document.getElementById('arrow-' + fromId + '-' + toId);

            if (!fromNode || !toNode || !line || !arrow) return;

            const fromElement = document.getElementById(fromId);
            const toElement = document.getElementById(toId);

            if (!fromElement || !toElement) return;

            const fromX = fromNode.x + fromElement.offsetWidth / 2;
            const fromY = fromNode.y + fromElement.offsetHeight / 2;
            const toX = toNode.x + toElement.offsetWidth / 2;
            const toY = toNode.y + toElement.offsetHeight / 2;

            const dx = toX - fromX;
            const dy = toY - fromY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            line.style.width = length + 'px';
            line.style.left = fromX + 'px';
            line.style.top = fromY + 'px';
            line.style.transform = 'rotate(' + angle + 'deg)';

            arrow.style.left = toX + 'px';
            arrow.style.top = toY + 'px';
            arrow.style.transform = 'rotate(' + angle + 'deg)';
        }

        // Actualizar todas las conexiones
        function updateConnections() {
            connections.forEach(conn => {
                updateConnection(conn.from, conn.to);
            });
        }

        // Actualizar contadores
        function updateCounters() {
            document.getElementById('nodesCount').textContent = nodes.length;
            document.getElementById('connectionsCount').textContent = connections.length;
        }

        // Limpiar todo
        function clearAll() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar todo?')) return;
            
            // Guardar estado antes de limpiar
            saveState();
            
            nodes = [];
            connections = [];
            selectedNodeId = null;
            selectedConnection = null;
            renderAll();
            updateCounters();
        }

        // Renderizar todo
        function renderAll() {
            workspace.innerHTML = '';
            nodes.forEach(node => renderNode(node));
            connections.forEach(conn => renderConnection(conn.from, conn.to));
            updateWorkspaceTransform();
            
            // Si estamos en modo desconexi√≥n, reactivar el modo
            if (disconnectMode) {
                setDisconnectMode(true);
            }
        }

        // Generar c√≥digo para exportar
        function generateExportCode() {
            const mapTitle = document.getElementById('mapTitle').value;
            const exportHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${mapTitle}</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Calibri', sans-serif; background: #1a1a2e; min-height: 100vh; padding: 10px; color: #e6e6e6; }
        .container { max-width: 1200px; margin: 0 auto; background: #16213e; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #e6e6e6; margin-bottom: 15px; font-size: 1.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .workspace-container { position: relative; width: 100%; height: 600px; overflow: auto; border: 1px solid #2d3748; border-radius: 8px; margin-bottom: 15px; background: #1a1a2e; display: flex; align-items: center; justify-content: center; }
        .a4-container { width: 1123px; height: 794px; background: ${a4Container.style.backgroundColor || 'white'}; box-shadow: 0 0 0 2px #8e44ad; position: relative; overflow: hidden; }
        .workspace { position: relative; width: 100%; height: 100%; }
        .node { position: absolute; min-width: 80px; max-width: 120px; padding: 8px; border-radius: 6px; cursor: pointer; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3); user-select: none; transition: all 0.2s ease; z-index: 10; }
        .node.small { font-size: 12px; }
        .node.medium { font-size: 14px; }
        .node.large { font-size: 16px; }
        .node:hover { transform: scale(1.03); box-shadow: 0 3px 12px rgba(0,0,0,0.4); }
        .node-title { font-weight: 600; margin-bottom: 2px; line-height: 1.2; word-wrap: break-word; }
        .node-subtitle { font-weight: 500; margin-bottom: 6px; font-style: italic; line-height: 1.2; opacity: 0.8; word-wrap: break-word; }
        .connection { position: absolute; background: #718096; height: 2px; transform-origin: 0 0; pointer-events: none; z-index: 5; }
        .connection-arrow { position: absolute; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 8px solid #718096; transform-origin: center; pointer-events: none; z-index: 6; }
        .info-panel { background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .info-panel h3 { font-family: 'Calibri', sans-serif; font-weight: 600; margin-bottom: 10px; color: #e6e6e6; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #1a1a2e; margin: 5% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); position: relative; max-height: 80vh; overflow-y: auto; border: 1px solid #2d3748; color: #e6e6e6; }
        .close-modal { position: absolute; right: 15px; top: 15px; font-size: 20px; font-weight: bold; cursor: pointer; color: #a0aec0; background: none; border: none; padding: 0; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; }
        .close-modal:hover { color: #e6e6e6; }
        .modal-title { font-family: 'EB Garamond', serif; font-size: 22px; margin-bottom: 8px; color: #e6e6e6; }
        .modal-subtitle { font-family: 'EB Garamond', serif; font-size: 14px; margin-bottom: 15px; color: #a0aec0; font-style: italic; }
        .modal-author { font-family: 'Calibri', sans-serif; font-size: 13px; margin-bottom: 15px; color: #a0aec0; font-style: italic; }
        .modal-image { max-width: 100%; max-height: 200px; margin: 15px 0; border-radius: 6px; display: block; margin-left: auto; margin-right: auto; }
        .modal-description { font-family: 'Calibri', sans-serif; font-size: 14px; line-height: 1.6; color: #e6e6e6; padding: 15px; background: #2d3748; border-radius: 6px; }
        @media (max-width: 768px) { .workspace-container { height: 500px; } .a4-container { width: 95%; height: 400px; } .node { min-width: 70px; max-width: 100px; padding: 6px; } .node.small { font-size: 11px; } .node.medium { font-size: 13px; } .node.large { font-size: 15px; } .modal-content { margin: 10% auto; padding: 20px; width: 95%; } h1 { font-size: 1.4em; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>${mapTitle}</h1>
        <div class="workspace-container">
            <div class="a4-container">
                <div class="workspace" id="workspace"></div>
            </div>
        </div>
        <div class="info-panel">
            <h3>INFORMACI√ìN DEL MAPA</h3>
            <p>Total de nodos: ${nodes.length} | Conexiones: ${connections.length}</p>
            <p>Haz click en cualquier nodo para ver m√°s informaci√≥n</p>
        </div>
    </div>

    <div id="descriptionModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <h2 class="modal-title" id="modalTitle"></h2>
            <h3 class="modal-subtitle" id="modalSubtitle"></h3>
            <div class="modal-author" id="modalAuthor"></div>
            <img id="modalImage" class="modal-image" style="display: none;" alt="Imagen del nodo">
            <div class="modal-description" id="modalDescription"></div>
        </div>
    </div>

    <script>
        const nodes = ${JSON.stringify(nodes)};
        const connections = ${JSON.stringify(connections)};
        
        function loadMap() {
            const workspace = document.getElementById('workspace');
            
            // Cargar nodos
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node ' + (node.fontSize || 'small');
                nodeElement.style.left = node.x + 'px';
                nodeElement.style.top = node.y + 'px';
                nodeElement.style.fontFamily = node.fontFamily || 'EB Garamond';
                
                // Aplicar color de fondo (incluyendo transparente)
                if (node.color === 'transparent') {
                    nodeElement.style.background = 'transparent';
                } else {
                    nodeElement.style.background = node.color || '#4a235a';
                }
                
                // Aplicar borde
                if (node.border === 'none') {
                    nodeElement.style.border = 'none';
                } else {
                    nodeElement.style.border = '1px solid #8e44ad';
                }
                
                nodeElement.style.color = node.textColor || 'white';
                nodeElement.innerHTML = 
                    '<div class="node-title">' + node.title + '</div>' + 
                    (node.subtitle ? '<div class="node-subtitle">' + node.subtitle + '</div>' : '');
                
                nodeElement.addEventListener('click', function() {
                    showDescriptionModal(node.id);
                });
                
                workspace.appendChild(nodeElement);
            });

            // Cargar conexiones
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const fromX = fromNode.x + 40;
                    const fromY = fromNode.y + 20;
                    const toX = toNode.x + 40;
                    const toY = toNode.y + 20;
                    
                    const dx = toX - fromX;
                    const dy = toY - fromY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    const line = document.createElement('div');
                    line.className = 'connection';
                    line.style.width = length + 'px';
                    line.style.left = fromX + 'px';
                    line.style.top = fromY + 'px';
                    line.style.transform = 'rotate(' + angle + 'deg)';
                    
                    const arrow = document.createElement('div');
                    arrow.className = 'connection-arrow';
                    arrow.style.left = toX + 'px';
                    arrow.style.top = toY + 'px';
                    arrow.style.transform = 'rotate(' + angle + 'deg)';
                    
                    workspace.appendChild(line);
                    workspace.appendChild(arrow);
                }
            });
        }

        function showDescriptionModal(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;

            document.getElementById('modalTitle').textContent = node.title;
            document.getElementById('modalSubtitle').textContent = node.subtitle || 'Sin subt√≠tulo';
            document.getElementById('modalAuthor').textContent = node.author ? 'Autor: ' + node.author : 'Autor no especificado';
            document.getElementById('modalDescription').textContent = node.description || 'Sin descripci√≥n disponible.';
            
            const modalImage = document.getElementById('modalImage');
            if (node.image) {
                modalImage.src = node.image;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            document.getElementById('descriptionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('descriptionModal').style.display = 'none';
        }

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('descriptionModal');
            if (event.target === modal) {
                closeModal();
            }
        });
        
        document.addEventListener('DOMContentLoaded', loadMap);
    <\/script>
</body>
</html>`;

            return exportHTML;
        }

        // Descargar como HTML
        function downloadHTML() {
            const exportCode = generateExportCode();
            const blob = new Blob([exportCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mapa-interactivo.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úÖ Archivo HTML guardado correctamente');
            closeSaveModal();
        }

        // Actualizar contenido de vista previa
        function updatePreviewContent() {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = '';
            
            // Crear una representaci√≥n simplificada del mapa
            const previewWorkspace = document.createElement('div');
            previewWorkspace.style.position = 'relative';
            previewWorkspace.style.width = '100%';
            previewWorkspace.style.height = '400px';
            previewWorkspace.style.overflow = 'auto';
            previewWorkspace.style.border = '1px solid #4a5568';
            previewWorkspace.style.borderRadius = '5px';
            previewWorkspace.style.padding = '10px';
            previewWorkspace.style.background = a4Container.style.backgroundColor || '#ffffff';
            
            // Agregar nodos a la vista previa
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node';
                nodeElement.style.position = 'absolute';
                nodeElement.style.left = (node.x / 1.5) + 'px';
                nodeElement.style.top = (node.y / 1.5) + 'px';
                nodeElement.style.minWidth = '60px';
                nodeElement.style.maxWidth = '80px';
                nodeElement.style.padding = '5px';
                nodeElement.style.fontFamily = node.fontFamily || 'EB Garamond';
                
                // Aplicar color de fondo (incluyendo transparente)
                if (node.color === 'transparent') {
                    nodeElement.style.background = 'transparent';
                } else {
                    nodeElement.style.background = node.color || '#4a235a';
                }
                
                // Aplicar borde
                if (node.border === 'none') {
                    nodeElement.style.border = 'none';
                } else {
                    nodeElement.style.border = '1px solid #8e44ad';
                }
                
                nodeElement.style.borderRadius = '4px';
                nodeElement.style.color = node.textColor || 'white';
                
                // Aplicar tama√±o de fuente
                let fontSize = '10px';
                if (node.fontSize === 'medium') fontSize = '12px';
                if (node.fontSize === 'large') fontSize = '14px';
                nodeElement.style.fontSize = fontSize;
                
                nodeElement.style.textAlign = 'center';
                
                nodeElement.innerHTML = `
                    <div style="font-weight: bold;">${node.title}</div>
                    ${node.subtitle ? `<div style="font-style: italic; font-size: ${parseInt(fontSize) - 1}px;">${node.subtitle}</div>` : ''}
                `;
                
                previewWorkspace.appendChild(nodeElement);
            });
            
            // Agregar conexiones a la vista previa
            connections.forEach(conn => {
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                if (fromNode && toNode) {
                    const fromX = (fromNode.x / 1.5) + 30;
                    const fromY = (fromNode.y / 1.5) + 15;
                    const toX = (toNode.x / 1.5) + 30;
                    const toY = (toNode.y / 1.5) + 15;
                    
                    const dx = toX - fromX;
                    const dy = toY - fromY;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                    const line = document.createElement('div');
                    line.style.position = 'absolute';
                    line.style.background = '#718096';
                    line.style.height = '2px';
                    line.style.width = length + 'px';
                    line.style.left = fromX + 'px';
                    line.style.top = fromY + 'px';
                    line.style.transform = 'rotate(' + angle + 'deg)';
                    line.style.transformOrigin = '0 0';
                    line.style.zIndex = '5';
                    
                    const arrow = document.createElement('div');
                    arrow.style.position = 'absolute';
                    arrow.style.width = '0';
                    arrow.style.height = '0';
                    arrow.style.borderLeft = '4px solid transparent';
                    arrow.style.borderRight = '4px solid transparent';
                    arrow.style.borderTop = '6px solid #718096';
                    arrow.style.left = toX + 'px';
                    arrow.style.top = toY + 'px';
                    arrow.style.transform = 'rotate(' + angle + 'deg)';
                    arrow.style.transformOrigin = 'center';
                    arrow.style.zIndex = '6';
                    
                    previewWorkspace.appendChild(line);
                    previewWorkspace.appendChild(arrow);
                }
            });
            
            previewContent.appendChild(previewWorkspace);
            
            // Agregar informaci√≥n de resumen
            const summary = document.createElement('div');
            summary.style.marginTop = '15px';
            summary.style.padding = '10px';
            summary.style.background = '#2d3748';
            summary.style.borderRadius = '5px';
            summary.innerHTML = `
                <h4 style="margin-bottom: 8px; color: #e6e6e6;">RESUMEN DEL MAPA</h4>
                <p>Total de nodos: ${nodes.length}</p>
                <p>Conexiones: ${connections.length}</p>
                <p>Fecha de generaci√≥n: ${new Date().toLocaleString()}</p>
            `;
            
            previewContent.appendChild(summary);
        }

        // Imprimir vista previa
        function printPreview() {
            const previewContent = document.getElementById('previewContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Mapa Interactivo - Vista Previa</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
                        .node { border: 1px solid #8e44ad; background: #f0f8ff; padding: 8px; margin: 5px; border-radius: 4px; display: inline-block; }
                        .summary { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <h1>Mapa Interactivo - Vista Previa</h1>
                    <div>${previewContent}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Funciones de zoom
        function zoomIn() {
            zoomLevel = Math.min(zoomLevel + 0.1, 2);
            updateWorkspaceTransform();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
            updateWorkspaceTransform();
        }

        function resetZoom() {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateWorkspaceTransform();
        }

        function updateWorkspaceTransform() {
            workspace.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
        }

        // Inicializar
        renderAll();
        updateCounters();
        saveState(); // Guardar estado inicial

        // Agregar algunos nodos de ejemplo al inicio
        setTimeout(() => {
            const node1 = {
                id: 'node-1',
                title: 'Arte y Ciencias Sociales',
                subtitle: 'Intersecciones disciplinares',
                author: 'Varios autores',
                description: 'Este mapa explora las conexiones entre el arte y las ciencias sociales, examinando c√≥mo se influyen mutuamente.',
                image: null,
                type: 'main',
                x: 100,
                y: 100,
                color: '#4a235a',
                textColor: 'white',
                fontSize: 'medium',
                fontFamily: 'EB Garamond',
                border: 'solid'
            };

            const node2 = {
                id: 'node-2',
                title: 'Antropolog√≠a Visual',
                subtitle: 'Estudio cultural de las im√°genes',
                author: 'Margaret Mead',
                description: 'La antropolog√≠a visual estudia c√≥mo las sociedades humanas producen, interpretan y utilizan las im√°genes visuales.',
                image: null,
                type: 'main',
                x: 300,
                y: 200,
                color: 'transparent',
                textColor: 'black',
                fontSize: 'small',
                fontFamily: 'Roboto',
                border: 'none'
            };

            nodes.push(node1, node2);
            renderAll();
            updateCounters();
            saveState(); // Guardar estado con nodos de ejemplo
        }, 500);
    </script>
</body>
</html>
