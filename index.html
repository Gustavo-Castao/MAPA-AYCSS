<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Mapas Conceptuales Pro</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --border-color: #ccc;
            --accent: #4a90e2;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: var(--bg-color); }
        
        /* UI Layout */
        #toolbar {
            position: fixed; top: 10px; left: 10px; width: 260px;
            background: var(--panel-bg); padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #333; }
        
        .control-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px; }
        label { font-size: 12px; color: #666; font-weight: bold; }
        input[type="color"] { width: 100%; height: 30px; border: none; cursor: pointer; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        button {
            padding: 10px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #357abd; }
        .btn-secondary { background: #eee; color: #333; }
        .btn-danger { background: #e74c3c; color: white; }
        
        /* Canvas Area */
        #workspace {
            width: 100vw; height: 100vh; position: relative;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* SVG Layer for Lines */
        #connections-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Allows clicking through to nodes */
            z-index: 0;
        }

        /* Nodes */
        .node {
            position: absolute; min-width: 100px; min-height: 50px;
            padding: 10px; border: 1px solid #aaa; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: move; user-select: none; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            text-align: center; resize: both; overflow: auto;
        }
        
        .node:focus, .node.selected {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
            z-index: 20;
        }

        .node-content {
            width: 100%; height: 100%; outline: none; cursor: text;
        }

        /* Mode Indicators */
        #mode-indicator {
            margin-top: 10px; font-size: 12px; color: #d35400; font-weight: bold; display: none;
        }

    </style>
</head>
<body>

    <div id="toolbar">
        <h3>Propiedades</h3>
        
        <div class="control-group">
            <button onclick="createNode()" class="btn-primary">+ Nuevo Nodo</button>
            <button onclick="toggleLinkMode()" id="btn-link" class="btn-secondary"> Vincular Nodos</button>
            <div id="mode-indicator">Modo Vincular: Selecciona 2 nodos</div>
        </div>

        <hr style="width:100%; border:0; border-top:1px solid #eee;">

        <div class="control-group">
            <label>Color Fondo</label>
            <input type="color" id="bg-color" value="#ffffff" onchange="updateSelectedNode('bg')">
        </div>
        <div class="control-group">
            <label>Color Texto</label>
            <input type="color" id="text-color" value="#000000" onchange="updateSelectedNode('color')">
        </div>
        <div class="control-group">
            <label>Tama帽o Texto</label>
            <input type="range" id="font-size" min="10" max="40" value="16" oninput="updateSelectedNode('size')">
        </div>

        <button onclick="deleteSelected()" class="btn-danger" style="margin-top:10px;"> Eliminar Seleccionado</button>
        
        <hr style="width:100%; border:0; border-top:1px solid #eee;">
        
        <h3>Exportar</h3>
        <button onclick="exportPNG()" class="btn-secondary"> Guardar PNG</button>
        <button onclick="exportHTML()" class="btn-secondary"> Guardar HTML</button>
    </div>

    <div id="workspace" ondrop="drop(event)" ondragover="allowDrop(event)">
        <svg id="connections-layer"></svg>
        </div>

    <script>
        // --- ESTADO DE LA APLICACIN ---
        let nodes = [];
        let connections = [];
        let selectedNodeId = null;
        let isLinkMode = false;
        let linkSourceId = null;

        const workspace = document.getElementById('workspace');
        const svgLayer = document.getElementById('connections-layer');

        // --- GESTIN DE NODOS ---

        // Generador de ID robusto para evitar conflictos
        function generateId() {
            return 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function createNode(loadData = null) {
            const id = loadData ? loadData.id : generateId();
            const x = loadData ? loadData.x : 300 + (nodes.length * 20);
            const y = loadData ? loadData.y : 100 + (nodes.length * 20);
            const text = loadData ? loadData.text : "Nuevo Concepto";
            const style = loadData ? loadData.style : { bg: '#ffffff', color: '#000000', size: '16px' };

            const node = document.createElement('div');
            node.className = 'node';
            node.id = id;
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            node.style.backgroundColor = style.bg;
            node.style.color = style.color;
            node.style.fontSize = style.size;

            // Contenido editable
            const content = document.createElement('div');
            content.className = 'node-content';
            content.contentEditable = true;
            content.innerText = text;
            // Prevenir que el arrastre se active al intentar seleccionar texto
            content.onmousedown = (e) => e.stopPropagation(); 
            node.appendChild(content);

            // Eventos del nodo
            node.onmousedown = (e) => startDrag(e, node);
            node.onclick = (e) => selectNode(e, node);

            workspace.appendChild(node);
            
            // Guardar en array l贸gico
            if(!loadData) {
                nodes.push({ id, x, y, text, style });
            }
            selectNode(null, node);
        }

        // --- SELECCIN Y EDICIN ---

        function selectNode(e, node) {
            if(e) e.stopPropagation();
            
            // Si estamos en modo vincular
            if (isLinkMode) {
                handleLinkClick(node.id);
                return;
            }

            // UI Feedback
            document.querySelectorAll('.node').forEach(n => n.classList.remove('selected'));
            node.classList.add('selected');
            selectedNodeId = node.id;

            // Cargar propiedades en el panel
            const nodeData = nodes.find(n => n.id === node.id);
            if(nodeData) {
                document.getElementById('bg-color').value = rgbToHex(node.style.backgroundColor);
                document.getElementById('text-color').value = rgbToHex(node.style.color);
                document.getElementById('font-size').value = parseInt(node.style.fontSize);
            }
        }

        function updateSelectedNode(prop) {
            if (!selectedNodeId) return;
            const nodeEl = document.getElementById(selectedNodeId);
            const nodeData = nodes.find(n => n.id === selectedNodeId);

            if (prop === 'bg') {
                const val = document.getElementById('bg-color').value;
                nodeEl.style.backgroundColor = val;
                nodeData.style.bg = val;
            } else if (prop === 'color') {
                const val = document.getElementById('text-color').value;
                nodeEl.style.color = val;
                nodeData.style.color = val;
            } else if (prop === 'size') {
                const val = document.getElementById('font-size').value + 'px';
                nodeEl.style.fontSize = val;
                nodeData.style.size = val;
            }
        }

        function deleteSelected() {
            if (!selectedNodeId) return;
            
            // Borrar conexiones asociadas
            connections = connections.filter(c => c.from !== selectedNodeId && c.to !== selectedNodeId);
            
            // Borrar nodo del DOM y Array
            document.getElementById(selectedNodeId).remove();
            nodes = nodes.filter(n => n.id !== selectedNodeId);
            
            selectedNodeId = null;
            renderConnections();
        }

        // --- SISTEMA DE VINCULACIN ---

        function toggleLinkMode() {
            isLinkMode = !isLinkMode;
            linkSourceId = null;
            const btn = document.getElementById('btn-link');
            const indicator = document.getElementById('mode-indicator');
            
            if (isLinkMode) {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                indicator.style.display = 'block';
                indicator.innerText = "Selecciona el nodo ORIGEN";
            } else {
                btn.classList.add('btn-secondary');
                btn.classList.remove('btn-primary');
                indicator.style.display = 'none';
            }
        }

        function handleLinkClick(id) {
            const indicator = document.getElementById('mode-indicator');
            
            if (!linkSourceId) {
                linkSourceId = id;
                indicator.innerText = "Ahora selecciona el nodo DESTINO";
                document.getElementById(id).style.borderColor = "blue";
            } else {
                if (linkSourceId !== id) {
                    // Crear conexi贸n
                    connections.push({ from: linkSourceId, to: id });
                    renderConnections();
                }
                // Resetear estado
                document.getElementById(linkSourceId).style.borderColor = "#aaa";
                toggleLinkMode(); // Salir del modo vincular
            }
        }

        // --- RENDERIZADO DE LNEAS SVG ---

        function renderConnections() {
            svgLayer.innerHTML = ''; // Limpiar SVG
            
            connections.forEach(conn => {
                const fromNode = document.getElementById(conn.from);
                const toNode = document.getElementById(conn.to);
                
                if (!fromNode || !toNode) return;

                // Calcular centros
                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                
                // Ajustar offset por el toolbar si fuera necesario, pero como es position absolute en body:
                const fromX = fromNode.offsetLeft + fromNode.offsetWidth / 2;
                const fromY = fromNode.offsetTop + fromNode.offsetHeight / 2;
                const toX = toNode.offsetLeft + toNode.offsetWidth / 2;
                const toY = toNode.offsetTop + toNode.offsetHeight / 2;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', fromX);
                line.setAttribute('y1', fromY);
                line.setAttribute('x2', toX);
                line.setAttribute('y2', toY);
                line.setAttribute('stroke', '#555');
                line.setAttribute('stroke-width', '2');
                
                svgLayer.appendChild(line);
            });
        }

        // --- DRAG AND DROP (ARRASTRE) ---
        
        let activeDrag = null;
        let initialX, initialY, initialLeft, initialTop;

        function startDrag(e, node) {
            if(e.target.contentEditable === "true") return; // Permitir edici贸n de texto
            
            activeDrag = node;
            initialX = e.clientX;
            initialY = e.clientY;
            initialLeft = node.offsetLeft;
            initialTop = node.offsetTop;
            
            selectNode(e, node);
            
            document.onmousemove = drag;
            document.onmouseup = endDrag;
        }

        function drag(e) {
            if (!activeDrag) return;
            e.preventDefault();
            
            const dx = e.clientX - initialX;
            const dy = e.clientY - initialY;
            
            activeDrag.style.left = (initialLeft + dx) + 'px';
            activeDrag.style.top = (initialTop + dy) + 'px';
            
            renderConnections(); // Actualizar l铆neas en tiempo real
        }

        function endDrag() {
            if (activeDrag) {
                // Actualizar datos del array l贸gico
                const nodeData = nodes.find(n => n.id === activeDrag.id);
                if(nodeData) {
                    nodeData.x = activeDrag.offsetLeft;
                    nodeData.y = activeDrag.offsetTop;
                }
            }
            activeDrag = null;
            document.onmousemove = null;
            document.onmouseup = null;
        }

        // --- EXPORTACIN ---

        function exportPNG() {
            // Deseleccionar todo para que no salga el borde azul
            document.querySelectorAll('.selected').forEach(n => n.classList.remove('selected'));
            
            // html2canvas captura el workspace
            html2canvas(document.querySelector("#workspace")).then(canvas => {
                const link = document.createElement('a');
                link.download = 'mapa_mental.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function exportHTML() {
            // Actualizar textos en el array de nodos antes de guardar
            nodes.forEach(n => {
                const el = document.getElementById(n.id);
                if(el) n.text = el.querySelector('.node-content').innerText;
            });

            const data = {
                nodes: nodes,
                connections: connections
            };
            
            const json = JSON.stringify(data);
            const blob = new Blob([
                // Guardamos el HTML completo incluyendo los datos para poder reabrirlo
                document.documentElement.outerHTML.replace('/*DATA_PLACEHOLDER*/', `window.loadData = ${json};`)
            ], {type: "text/html"});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "mi_mapa.html";
            link.click();
        }

        // --- INICIALIZACIN Y RECUPERACIN ---
        
        // Helper para colores
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            const rgbValues = rgb.match(/\d+/g);
            if (!rgbValues) return '#ffffff';
            return "#" + ((1 << 24) + (parseInt(rgbValues[0]) << 16) + (parseInt(rgbValues[1]) << 8) + parseInt(rgbValues[2])).toString(16).slice(1);
        }

        // Carga autom谩tica si el archivo se guard贸 a s铆 mismo
        window.onload = function() {
            // Ajustar tama帽o del canvas SVG al redimensionar ventana
            window.onresize = renderConnections;

            if (window.loadData) {
                nodes = []; // Limpiar por si acaso
                window.loadData.nodes.forEach(n => createNode(n));
                connections = window.loadData.connections;
                setTimeout(renderConnections, 100);
            } else {
                // Nodo inicial
                createNode();
            }
        };

        /*DATA_PLACEHOLDER*/ // Aqu铆 se inyectar谩n los datos al exportar HTML
    </script>
</body>
</html>
